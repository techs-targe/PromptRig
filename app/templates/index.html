{% extends "base.html" %}

{% block title %}{{ app_name | default('PromptRig') }}{% endblock %}

{% block content %}
<div class="container">
    <!-- Tab Navigation -->
    <div class="tab-navigation">
        <button class="tab-button active" data-tab="single">単発実行</button>
        <button class="tab-button" data-tab="batch">バッチ実行</button>
        <button class="tab-button" data-tab="workflows">ワークフロー</button>
        <button class="tab-button" data-tab="projects">プロジェクト設定</button>
        <button class="tab-button" data-tab="settings">システム設定</button>
        <button class="tab-button" data-tab="datasets">データセット</button>
        <button class="tab-button" data-tab="agent">AIエージェント</button>
    </div>

    <!-- Tab Content Areas -->

    <!-- Single Execution Tab -->
    <div id="tab-single" class="tab-content active">
        <!-- Control Panel -->
        <div class="exec-control-panel">
            <div class="exec-control-row">
                <div class="exec-control-group">
                    <label class="exec-control-label">
                        <span class="exec-control-icon">📁</span>
                        プロジェクト / Project
                    </label>
                    <select id="single-project-select" class="exec-select">
                        <option value="">Loading...</option>
                    </select>
                </div>
                <div class="exec-control-group">
                    <label class="exec-control-label">
                        <span class="exec-control-icon">🎯</span>
                        実行対象 / Target
                    </label>
                    <select id="single-target-select" class="exec-select" style="min-width: 200px;">
                        <option value="">Loading...</option>
                    </select>
                </div>
                <div class="exec-control-group">
                    <label class="exec-control-label">
                        <span class="exec-control-icon">🤖</span>
                        モデル / Model
                    </label>
                    <select id="model-select" class="exec-select">
                        <option value="azure-gpt-4.1">Azure GPT-4.1</option>
                        <option value="openai-gpt-4.1-nano">OpenAI GPT-4.1-nano</option>
                    </select>
                </div>
                <div class="exec-control-group exec-control-actions">
                    <button id="btn-edit-prompt" class="btn btn-outline">
                        <span>✏️</span> プロンプト編集
                    </button>
                </div>
            </div>
        </div>

        <div class="main-content">
            <!-- History Sidebar -->
            <div class="left-pane exec-sidebar">
                <div class="exec-sidebar-header">
                    <h3><span class="exec-control-icon">📜</span> 実行履歴 / History</h3>
                    <button id="btn-reload-single-history" class="btn btn-icon" title="更新">🔄</button>
                </div>
                <div id="history-list" class="history-list">
                    <p class="loading">Loading...</p>
                </div>
            </div>

            <!-- Main Content Area -->
            <div class="right-pane">
                <!-- Current Project/Prompt Info -->
                <div id="current-context-info" class="current-context-bar">
                    <div class="context-info-left">
                        <span class="context-item">📁 <span id="current-project-name">-</span></span>
                        <span class="context-separator">/</span>
                        <span class="context-item">🎯 <span id="current-prompt-name">-</span></span>
                        <span id="current-history-info" class="context-history-info" style="display: none;">
                            <span class="context-separator">/</span>
                            <span class="context-item">📋 <span id="current-job-info">-</span></span>
                        </span>
                    </div>
                    <button id="btn-new-input" class="btn btn-new-input" title="新規入力 / New Input">
                        ✨ 新規入力
                    </button>
                    <button id="btn-context-execute" class="btn btn-primary btn-context-execute" title="送信 / Execute" style="display: none;">
                        🚀 送信
                    </button>
                </div>

                <!-- Prompt Template Card -->
                <div class="exec-card">
                    <div class="exec-card-header">
                        <h3><span class="exec-control-icon">📝</span> プロンプトテンプレート / Prompt Template</h3>
                    </div>
                    <div class="exec-card-body">
                        <div class="prompt-template-box response-box-container">
                            <button class="response-box-copy-btn" onclick="copyPromptTemplate()" title="コピー / Copy">
                                <svg width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><rect x="9" y="9" width="13" height="13" rx="2" ry="2"></rect><path d="M5 15H4a2 2 0 0 1-2-2V4a2 2 0 0 1 2-2h9a2 2 0 0 1 2 2v1"></path></svg>
                            </button>
                            <pre id="prompt-template">Loading...</pre>
                        </div>
                    </div>
                </div>

                <!-- Input Parameters Card -->
                <div class="exec-card">
                    <div class="exec-card-header">
                        <h3><span class="exec-control-icon">⚡</span> 入力パラメータ / Input Parameters</h3>
                        <button type="button" id="btn-select-from-dataset" class="btn btn-outline btn-sm" onclick="showDatasetSelectorForSingle()">
                            📋 データセットから選択
                        </button>
                    </div>
                    <div class="exec-card-body">
                        <form id="input-form">
                            <div id="parameter-inputs">
                                <p class="loading">Loading...</p>
                            </div>

                            <div id="execution-status" class="status-message"></div>

                            <div class="exec-action-bar">
                                <div class="exec-action-primary">
                                    <button type="button" id="btn-send-once" class="btn btn-primary btn-lg">
                                        ▶️ 1件送信 / Send Once
                                    </button>
                                    <button type="button" id="btn-stop-single" class="btn btn-danger btn-lg" style="display: none;">
                                        ⏹ 停止 / Stop
                                    </button>
                                </div>
                                <div class="exec-action-secondary">
                                    <div class="exec-repeat-control">
                                        <label for="repeat-count">回数:</label>
                                        <input type="number" id="repeat-count" min="1" max="10" value="3" class="exec-input-number">
                                        <button type="button" id="btn-send-repeat" class="btn btn-secondary">
                                            🔁 n回送信
                                        </button>
                                    </div>
                                    <label class="exec-checkbox">
                                        <input type="checkbox" id="single-include-csv-header" checked>
                                        <span>CSVヘッダを１行目のみに含める</span>
                                    </label>
                                </div>
                            </div>
                        </form>
                    </div>
                </div>

                <!-- Results Card -->
                <div class="exec-card">
                    <div class="exec-card-header">
                        <h3><span class="exec-control-icon">📊</span> 実行結果 / Results</h3>
                    </div>
                    <div class="exec-card-body">
                        <div id="results-area">
                            <p class="info">実行結果がここに表示されます / Results will be displayed here</p>
                        </div>
                    </div>
                </div>

                <!-- Utility Buttons -->
                <div class="utility-buttons" id="single-utility-buttons">
                    <button type="button" class="utility-btn" onclick="scrollToTop('tab-single')" title="ページトップへ">⬆</button>
                    <button type="button" class="utility-btn" onclick="scrollToBottom('tab-single')" title="ページボトムへ">⬇</button>
                </div>
            </div>
        </div>
    </div>

    <!-- Batch Execution Tab -->
    <div id="tab-batch" class="tab-content">
        <!-- Control Panel -->
        <div class="exec-control-panel">
            <div class="exec-control-row">
                <div class="exec-control-group">
                    <label class="exec-control-label">
                        <span class="exec-control-icon">📁</span>
                        プロジェクト / Project
                    </label>
                    <select id="batch-project-select" class="exec-select">
                        <option value="">Loading...</option>
                    </select>
                </div>
                <div class="exec-control-group">
                    <label class="exec-control-label">
                        <span class="exec-control-icon">🎯</span>
                        プロンプト / Prompt
                    </label>
                    <select id="batch-prompt-select" class="exec-select" style="min-width: 200px;">
                        <option value="">プロンプトを選択 / Select Prompt</option>
                    </select>
                </div>
                <div class="exec-control-group">
                    <label class="exec-control-label">
                        <span class="exec-control-icon">📋</span>
                        データセット / Dataset
                    </label>
                    <select id="batch-dataset-select" class="exec-select" style="min-width: 200px;">
                        <option value="">データセットを選択 / Select Dataset</option>
                    </select>
                </div>
                <div class="exec-control-group">
                    <label class="exec-control-label">
                        <span class="exec-control-icon">🤖</span>
                        モデル / Model
                    </label>
                    <select id="batch-model-select" class="exec-select">
                        <option value="azure-gpt-4.1">Azure GPT-4.1</option>
                        <option value="openai-gpt-4.1-nano">OpenAI GPT-4.1-nano</option>
                    </select>
                </div>
                <div class="exec-control-group exec-control-actions">
                    <button id="btn-batch-edit-prompt" class="btn btn-outline">
                        <span>✏️</span> プロンプト編集
                    </button>
                </div>
            </div>
            <div class="exec-control-row exec-control-row-actions">
                <label class="exec-checkbox">
                    <input type="checkbox" id="batch-include-csv-header" checked>
                    <span>CSVヘッダを１行目のみに含める</span>
                </label>
                <div class="exec-batch-buttons">
                    <button id="btn-batch-execute" class="btn btn-primary btn-lg">
                        🚀 バッチ実行開始 / Start Batch
                    </button>
                    <button id="btn-stop-batch" class="btn btn-danger btn-lg" style="display: none;">
                        ⏹ 停止 / Stop
                    </button>
                </div>
            </div>
        </div>

        <div class="main-content">
            <!-- History Sidebar -->
            <div class="left-pane exec-sidebar">
                <div class="exec-sidebar-header">
                    <h3><span class="exec-control-icon">📜</span> バッチジョブ履歴</h3>
                    <button id="btn-reload-batch-history" class="btn btn-icon" title="更新">🔄</button>
                </div>
                <div id="batch-jobs-list" class="history-list">
                    <p class="loading">Loading...</p>
                </div>
            </div>

            <!-- Main Content Area -->
            <div class="right-pane">
                <!-- Current Project/Prompt Info -->
                <div id="batch-context-info" class="current-context-bar">
                    <span class="context-item">📁 <span id="batch-project-name">-</span></span>
                    <span class="context-separator">/</span>
                    <span class="context-item">🎯 <span id="batch-prompt-name">-</span></span>
                    <span id="batch-history-info" class="context-history-info" style="display: none;">
                        <span class="context-separator">/</span>
                        <span class="context-item">📋 <span id="batch-job-info">-</span></span>
                    </span>
                </div>

                <!-- Results Card -->
                <div class="exec-card">
                    <div class="exec-card-header">
                        <h3><span class="exec-control-icon">📊</span> バッチ実行結果 / Batch Results</h3>
                    </div>
                    <div class="exec-card-body">
                        <div id="batch-execution-status" style="display: none;"></div>
                        <div id="batch-results-area">
                            <p class="info">バッチジョブを選択すると結果が表示されます / Select a batch job to view results</p>
                        </div>
                    </div>
                </div>

                <!-- Utility Buttons -->
                <div class="utility-buttons" id="batch-utility-buttons">
                    <button type="button" class="utility-btn" onclick="scrollToTop('tab-batch')" title="ページトップへ">⬆</button>
                    <button type="button" class="utility-btn" onclick="scrollToBottom('tab-batch')" title="ページボトムへ">⬇</button>
                </div>
            </div>
        </div>
    </div>

    <!-- Workflows Tab -->
    <div id="tab-workflows" class="tab-content">
        <!-- Workflow Header Section -->
        <div class="workflow-header-section">
            <div class="workflow-header-top">
                <div class="workflow-header-title">
                    <h2>ワークフロー / Workflows</h2>
                    <p class="workflow-header-desc">複数のプロンプトを連結して実行</p>
                </div>
                <div class="workflow-header-actions">
                    <button id="btn-create-workflow" class="workflow-action-btn workflow-action-btn-primary" onclick="showCreateWorkflowForm()" disabled>
                        <svg class="workflow-action-icon" viewBox="0 0 20 20" fill="currentColor">
                            <path fill-rule="evenodd" d="M10 3a1 1 0 011 1v5h5a1 1 0 110 2h-5v5a1 1 0 11-2 0v-5H4a1 1 0 110-2h5V4a1 1 0 011-1z" clip-rule="evenodd"/>
                        </svg>
                        <span>新規作成</span>
                    </button>
                    <button id="btn-import-workflow" class="workflow-action-btn" onclick="showImportWorkflowDialog()">
                        <svg class="workflow-action-icon" viewBox="0 0 20 20" fill="currentColor">
                            <path fill-rule="evenodd" d="M3 17a1 1 0 011-1h12a1 1 0 110 2H4a1 1 0 01-1-1zm3.293-7.707a1 1 0 011.414 0L9 10.586V3a1 1 0 112 0v7.586l1.293-1.293a1 1 0 111.414 1.414l-3 3a1 1 0 01-1.414 0l-3-3a1 1 0 010-1.414z" clip-rule="evenodd"/>
                        </svg>
                        <span>インポート</span>
                    </button>
                    <button id="btn-workflow-reference" class="workflow-action-btn" onclick="showWorkflowReference()">
                        <svg class="workflow-action-icon" viewBox="0 0 20 20" fill="currentColor">
                            <path d="M9 4.804A7.968 7.968 0 005.5 4c-1.255 0-2.443.29-3.5.804v10A7.969 7.969 0 015.5 14c1.669 0 3.218.51 4.5 1.385A7.962 7.962 0 0114.5 14c1.255 0 2.443.29 3.5.804v-10A7.968 7.968 0 0014.5 4c-1.255 0-2.443.29-3.5.804V12a1 1 0 11-2 0V4.804z"/>
                        </svg>
                        <span>リファレンス</span>
                    </button>
                    <button id="btn-function-reference" class="workflow-action-btn" onclick="showFunctionReference()">
                        <svg class="workflow-action-icon" viewBox="0 0 20 20" fill="currentColor">
                            <path fill-rule="evenodd" d="M12.316 3.051a1 1 0 01.633 1.265l-4 12a1 1 0 11-1.898-.632l4-12a1 1 0 011.265-.633zM5.707 6.293a1 1 0 010 1.414L3.414 10l2.293 2.293a1 1 0 11-1.414 1.414l-3-3a1 1 0 010-1.414l3-3a1 1 0 011.414 0zm8.586 0a1 1 0 011.414 0l3 3a1 1 0 010 1.414l-3 3a1 1 0 11-1.414-1.414L16.586 10l-2.293-2.293a1 1 0 010-1.414z" clip-rule="evenodd"/>
                        </svg>
                        <span>関数</span>
                    </button>
                </div>
            </div>
            <div class="workflow-project-selector">
                <label class="workflow-project-label">
                    <span class="label-icon">📁</span>
                    プロジェクト
                </label>
                <select id="workflow-project-select" class="workflow-project-dropdown" onchange="onWorkflowProjectChange()">
                    <option value="">-- 選択してください --</option>
                </select>
                <span id="workflow-project-hint" class="workflow-project-hint">
                    ※ プロジェクトを選択すると作成可能になります
                </span>
            </div>
        </div>

        <div class="main-content">
            <div class="left-pane">
                <div class="workflow-list-header">
                    <h3 class="workflow-list-title">一覧</h3>
                    <button type="button" class="btn-refresh-workflows" onclick="refreshWorkflowList()" title="リストを更新 / Refresh list">
                        🔄
                    </button>
                </div>
                <input type="text" id="workflow-search" class="workflow-search-input"
                       placeholder="🔍 検索..." oninput="filterWorkflowList(this.value)">
                <div id="workflow-list" class="history-list">
                    <!-- Workflow list will be rendered here -->
                </div>
            </div>

            <div class="right-pane">
                <!-- Workflow Editor (hidden by default) -->
                <div id="workflow-editor" class="workflow-editor-panel" style="display: none;">
                    <div class="workflow-editor-header">
                        <h3 id="workflow-editor-title" class="workflow-title-clickable" onclick="focusWorkflowName()" title="クリックして名前を編集 / Click to edit name">ワークフロー作成</h3>
                        <span id="workflow-editor-id-info" style="color: #aaa; font-size: 0.75rem; margin-left: 0.5rem;"></span>
                        <button class="btn-close-editor" onclick="hideWorkflowEditor()" title="閉じる">×</button>
                    </div>
                    <form id="workflow-form" class="workflow-editor-form" onsubmit="event.preventDefault(); saveWorkflow();">
                        <div class="workflow-basic-info">
                            <div class="form-group">
                                <label>名前</label>
                                <input type="text" id="workflow-name" required placeholder="ワークフロー名を入力">
                            </div>
                            <div class="form-group">
                                <label>📁 プロジェクト <span class="optional-label">(任意)</span></label>
                                <select id="workflow-project" class="workflow-project-select">
                                    <option value="">-- 未設定 / Not set --</option>
                                </select>
                            </div>
                            <div class="form-group">
                                <label>説明 <span class="optional-label">(任意)</span></label>
                                <textarea id="workflow-description" rows="2" placeholder="このワークフローの説明"></textarea>
                            </div>
                            <div class="form-group" style="margin-top: 0.75rem;">
                                <label class="checkbox-label" style="display: flex; align-items: center; gap: 0.5rem; cursor: pointer;">
                                    <input type="checkbox" id="workflow-auto-context" style="width: 18px; height: 18px;">
                                    <span>自動CONTEXT / Auto-Context</span>
                                    <span class="optional-label" style="font-weight: normal;">(前ステップのUSER/ASSISTANTをCONTEXTに自動追加)</span>
                                </label>
                            </div>
                        </div>

                        <div class="workflow-steps-section">
                            <div class="steps-section-header">
                                <h4>ステップ構成</h4>
                                <span class="steps-hint">前のステップの出力: <code>{% raw %}{{step1.field}}{% endraw %}</code></span>
                            </div>
                            <div class="workflow-collapse-controls">
                                <button type="button" class="btn-expand-all" onclick="expandAllWorkflowSteps()">全て展開</button>
                                <button type="button" class="btn-collapse-all" onclick="collapseAllWorkflowSteps()">全て折りたたむ</button>
                            </div>
                            <div id="workflow-steps-container">
                                <!-- Dynamic step forms will be added here -->
                            </div>
                            <button type="button" class="btn-add-step" onclick="addWorkflowStep()">
                                <span class="btn-icon">+</span> ステップ追加
                            </button>
                        </div>

                        <div class="workflow-form-actions">
                            <input type="hidden" id="workflow-id" value="">
                            <button type="submit" class="btn btn-primary">保存</button>
                            <button type="button" class="btn btn-secondary" onclick="saveWorkflowAs()" id="btn-workflow-save-as" style="display: none;">別名で保存</button>
                            <button type="button" class="btn btn-secondary" onclick="openWorkflowJsonEditor()" id="btn-workflow-json-edit" style="display: none;">JSON編集</button>
                            <button type="button" class="btn btn-secondary" onclick="exportWorkflow()" id="btn-workflow-export" style="display: none;">JSONエクスポート</button>
                            <button type="button" class="btn btn-secondary" onclick="hideWorkflowEditor()">キャンセル</button>
                            <button type="button" class="btn btn-danger" onclick="deleteWorkflow()" id="btn-workflow-delete" style="display: none;">削除</button>
                        </div>
                    </form>
                </div>

            </div>
        </div>
    </div>

    <!-- Projects Tab -->
    <div id="tab-projects" class="tab-content">
        <div class="projects-page">
            <!-- Page Header -->
            <div class="projects-header">
                <div class="projects-header-content">
                    <h2>📁 プロジェクト設定</h2>
                    <p class="projects-subtitle">プロンプトとパーサーを管理するプロジェクトを作成・編集します</p>
                    <button id="btn-create-project" class="btn btn-sm btn-outline" style="margin-top: 0.75rem;">
                        ＋ 新規プロジェクト作成
                    </button>
                </div>
            </div>

            <!-- Projects Grid -->
            <div id="projects-list" class="projects-grid">
                <p class="loading">読み込み中...</p>
            </div>
        </div>
    </div>

    <!-- System Settings Tab -->
    <div id="tab-settings" class="tab-content">
        <div class="settings-page">
            <!-- Page Header -->
            <div class="settings-header">
                <h2>システム設定</h2>
                <p class="settings-subtitle">アプリケーションの動作をカスタマイズします</p>
            </div>

            <!-- Settings Grid Layout -->
            <div class="settings-grid">
                <!-- Default Settings Card -->
                <div class="settings-card">
                    <div class="settings-card-header">
                        <span class="settings-card-icon">⚙️</span>
                        <h3>デフォルト設定</h3>
                    </div>
                    <div class="settings-card-body">
                        <!-- Default Model -->
                        <div class="settings-row">
                            <div class="settings-row-label">
                                <span class="settings-label">デフォルトLLMモデル</span>
                            </div>
                            <div class="settings-row-control">
                                <select id="default-model-select" class="settings-select">
                                    <option value="">読み込み中...</option>
                                </select>
                                <button id="btn-save-default-model" class="btn btn-primary btn-sm">保存</button>
                            </div>
                        </div>
                        <p class="settings-hint">単発実行・バッチ実行のデフォルトモデル</p>

                    </div>
                </div>

                <!-- Job Execution Card -->
                <div class="settings-card">
                    <div class="settings-card-header">
                        <span class="settings-card-icon">🚀</span>
                        <h3>ジョブ実行</h3>
                    </div>
                    <div class="settings-card-body">
                        <div class="settings-row">
                            <div class="settings-row-label">
                                <span class="settings-label">並列実行数（1〜99）</span>
                            </div>
                            <div class="settings-row-control">
                                <input type="number" id="job-parallelism" min="1" max="99" value="1" class="settings-input-number">
                                <button id="btn-save-parallelism" class="btn btn-primary btn-sm">保存</button>
                                <span id="parallelism-status" class="settings-status"></span>
                            </div>
                        </div>
                        <p class="settings-hint">同時に実行するジョブアイテムの数（1 = 直列実行）</p>

                        <!-- Agent Max Iterations -->
                        <div class="settings-row" style="margin-top: 1rem; padding-top: 1rem; border-top: 1px solid #eee;">
                            <div class="settings-row-label">
                                <span class="settings-label">Agentデフォルトイテレーション</span>
                            </div>
                            <div class="settings-row-control">
                                <select id="agent-max-iterations" class="settings-select">
                                    <option value="10">10回</option>
                                    <option value="20">20回</option>
                                    <option value="30" selected>30回</option>
                                    <option value="50">50回</option>
                                    <option value="70">70回</option>
                                    <option value="99">99回</option>
                                </select>
                                <button id="btn-save-agent-iterations" class="btn btn-primary btn-sm">保存</button>
                                <span id="agent-iterations-status" class="settings-status"></span>
                            </div>
                        </div>
                        <p class="settings-hint">Agentタブで使用するデフォルトのイテレーション数（チャット画面で個別に変更可能）</p>
                    </div>
                </div>

                <!-- Agent Settings Card -->
                <div class="settings-card">
                    <div class="settings-card-header">
                        <span class="settings-card-icon">🤖</span>
                        <h3>エージェント設定</h3>
                    </div>
                    <div class="settings-card-body">
                        <div class="settings-row">
                            <div class="settings-row-label">
                                <span class="settings-label">ガードレールモデル</span>
                            </div>
                            <div class="settings-row-control">
                                <select id="guardrail-model-select" class="settings-select">
                                    <option value="">読み込み中...</option>
                                </select>
                                <button id="btn-save-guardrail-model" class="btn btn-primary btn-sm">保存</button>
                                <span id="guardrail-model-status" class="settings-status"></span>
                            </div>
                        </div>
                        <p class="settings-hint">エージェントのセキュリティチェックに使用する軽量モデル</p>

                        <!-- Agent Stream Timeout -->
                        <div class="settings-row" style="margin-top: 1rem; padding-top: 1rem; border-top: 1px solid #eee;">
                            <div class="settings-row-label">
                                <span class="settings-label">ストリームタイムアウト（1〜30分）</span>
                            </div>
                            <div class="settings-row-control">
                                <select id="agent-stream-timeout" class="settings-select">
                                    <option value="60">1分</option>
                                    <option value="120">2分</option>
                                    <option value="180">3分</option>
                                    <option value="300" selected>5分（デフォルト）</option>
                                    <option value="600">10分</option>
                                    <option value="900">15分</option>
                                    <option value="1200">20分</option>
                                    <option value="1800">30分</option>
                                </select>
                                <button id="btn-save-agent-stream-timeout" class="btn btn-primary btn-sm">保存</button>
                                <span id="agent-stream-timeout-status" class="settings-status"></span>
                            </div>
                        </div>
                        <p class="settings-hint">エージェントの進捗表示の最大時間。タイムアウト後もタスクは継続します</p>
                    </div>
                </div>

                <!-- File Processing Card -->
                <div class="settings-card">
                    <div class="settings-card-header">
                        <span class="settings-card-icon">📄</span>
                        <h3>ファイル処理</h3>
                    </div>
                    <div class="settings-card-body">
                        <div class="settings-row">
                            <div class="settings-row-label">
                                <span class="settings-label">テキスト拡張子</span>
                            </div>
                            <div class="settings-row-control" style="flex-direction: column; align-items: flex-start; gap: 0.5rem;">
                                <div style="display: flex; gap: 0.5rem; width: 100%;">
                                    <input type="text" id="text-file-extensions" class="settings-input-text" style="flex: 1;" placeholder="txt,csv,md,json...">
                                    <button id="btn-save-text-extensions" class="btn btn-primary btn-sm">保存</button>
                                    <button id="btn-reset-text-extensions" class="btn btn-secondary btn-sm">リセット</button>
                                </div>
                                <span id="text-extensions-status" class="settings-status"></span>
                            </div>
                        </div>
                        <p class="settings-hint">FILEPATHパラメータでテキストとして展開する拡張子（カンマ区切り）<br>空欄にすると全てのファイルが画像としてLLMに送信されます</p>
                    </div>
                </div>

                <!-- Model Parameters Card -->
                <div class="settings-card settings-card-wide">
                    <div class="settings-card-header">
                        <span class="settings-card-icon">🎛️</span>
                        <h3>モデルパラメータ</h3>
                    </div>
                    <div class="settings-card-body">
                        <div class="settings-row">
                            <div class="settings-row-label">
                                <span class="settings-label">モデル選択</span>
                            </div>
                            <div class="settings-row-control">
                                <select id="param-model-select" class="settings-select">
                                    <option value="">読み込み中...</option>
                                </select>
                            </div>
                        </div>

                        <!-- 環境変数設定状態 -->
                        <div id="model-env-status" class="model-env-status-section" style="display: none;">
                            <div class="env-status-header">環境変数設定</div>
                            <div id="model-env-vars-list" class="env-vars-compact-list"></div>
                        </div>

                        <div id="model-parameters-form" class="model-params-form" style="display: none;">
                            <div class="params-grid">
                                <div class="param-item" id="param-temperature-group">
                                    <label class="param-label">Temperature</label>
                                    <div class="param-input-row">
                                        <input type="number" id="param-temperature" min="0" max="2" step="0.1" value="0.7" class="settings-input-number">
                                        <span id="default-temperature" class="param-default"></span>
                                    </div>
                                    <span class="param-range">0 - 2</span>
                                </div>
                                <div class="param-item" id="param-max-tokens-group">
                                    <label class="param-label">Max Tokens</label>
                                    <div class="param-input-row">
                                        <input type="number" id="param-max-tokens" min="100" max="32000" step="100" value="4000" class="settings-input-number">
                                        <span id="default-max-tokens" class="param-default"></span>
                                    </div>
                                    <span class="param-range">100 - 32000</span>
                                </div>
                                <div class="param-item" id="param-top-p-group">
                                    <label class="param-label">Top P</label>
                                    <div class="param-input-row">
                                        <input type="number" id="param-top-p" min="0" max="1" step="0.1" value="1.0" class="settings-input-number">
                                        <span id="default-top-p" class="param-default"></span>
                                    </div>
                                    <span class="param-range">0 - 1</span>
                                </div>
                                <div class="param-item" id="param-max-output-tokens-group" style="display: none;">
                                    <label class="param-label">Max Output Tokens <span class="param-badge">GPT-5</span></label>
                                    <div class="param-input-row">
                                        <input type="number" id="param-max-output-tokens" min="1024" max="65536" step="1024" value="8192" class="settings-input-number">
                                        <span id="default-max-output-tokens" class="param-default"></span>
                                    </div>
                                    <span class="param-range">推奨: 8192 - 16384</span>
                                </div>
                                <div class="param-item" id="param-verbosity-group" style="display: none;">
                                    <label class="param-label">Verbosity <span class="param-badge">GPT-5</span></label>
                                    <div class="param-input-row">
                                        <select id="param-verbosity" class="settings-select-sm">
                                            <option value="low">Low</option>
                                            <option value="medium">Medium</option>
                                            <option value="high">High</option>
                                        </select>
                                        <span id="default-verbosity" class="param-default"></span>
                                    </div>
                                </div>
                                <div class="param-item" id="param-reasoning-effort-group" style="display: none;">
                                    <label class="param-label">Reasoning Effort <span class="param-badge">GPT-5</span></label>
                                    <div class="param-input-row">
                                        <select id="param-reasoning-effort" class="settings-select-sm">
                                            <option value="minimal">Minimal</option>
                                            <option value="low">Low</option>
                                            <option value="medium">Medium</option>
                                            <option value="high">High</option>
                                        </select>
                                        <span id="default-reasoning-effort" class="param-default"></span>
                                    </div>
                                </div>
                            </div>
                            <div class="params-actions">
                                <button id="btn-save-model-params" class="btn btn-primary">パラメータ保存</button>
                                <button id="btn-reset-model-params" class="btn btn-secondary">デフォルトに戻す</button>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Available Models Card -->
                <div class="settings-card">
                    <div class="settings-card-header">
                        <span class="settings-card-icon">🤖</span>
                        <h3>利用可能なモデル</h3>
                    </div>
                    <div class="settings-card-body">
                        <div id="available-models" class="models-button-grid">
                            <p class="loading">読み込み中...</p>
                        </div>
                    </div>
                </div>

                <!-- Model Configuration Card -->
                <div class="settings-card">
                    <div class="settings-card-header">
                        <span class="settings-card-icon">🔧</span>
                        <h3>モデル設定</h3>
                    </div>
                    <div class="settings-card-body">
                        <p class="settings-hint" style="margin-bottom: 1rem;">各モデルの有効/無効とパラメータを設定</p>
                        <div id="model-configuration-settings" class="model-config-list">
                            <p class="loading">読み込み中...</p>
                        </div>
                    </div>
                </div>

                <!-- API Configuration Card -->
                <div class="settings-card">
                    <div class="settings-card-header">
                        <span class="settings-card-icon">🔑</span>
                        <h3>API設定</h3>
                    </div>
                    <div class="settings-card-body">
                        <div class="api-info-box">
                            <p class="api-info-text">API設定は <code>.env</code> ファイルで管理されます</p>
                        </div>
                        <div class="api-keys-list">
                            <div class="api-key-item">
                                <span class="api-key-name">AZURE_OPENAI_ENDPOINT</span>
                                <span class="api-key-badge required">必須</span>
                            </div>
                            <div class="api-key-item">
                                <span class="api-key-name">AZURE_OPENAI_API_KEY</span>
                                <span class="api-key-badge required">必須</span>
                            </div>
                            <div class="api-key-item">
                                <span class="api-key-name">OPENAI_API_KEY</span>
                                <span class="api-key-badge optional">任意</span>
                            </div>
                            <div class="api-key-item">
                                <span class="api-key-name">AZURE_OPENAI_GPT5_MINI_DEPLOYMENT_NAME</span>
                                <span class="api-key-badge optional">任意</span>
                            </div>
                            <div class="api-key-item">
                                <span class="api-key-name">AZURE_OPENAI_GPT5_NANO_DEPLOYMENT_NAME</span>
                                <span class="api-key-badge optional">任意</span>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Tag Management Card -->
                <div class="settings-card settings-card-wide">
                    <div class="settings-card-header">
                        <span class="settings-card-icon">🏷️</span>
                        <h3>タグ管理</h3>
                    </div>
                    <div class="settings-card-body">
                        <p class="settings-hint" style="margin-bottom: 1rem;">
                            プロンプトにタグを付けてアクセス制御を行います。モデルごとに許可タグを設定できます。
                        </p>

                        <!-- Tag List -->
                        <div class="tag-management-section">
                            <div class="tag-section-header">
                                <h4>登録タグ一覧</h4>
                                <button class="btn btn-primary btn-sm" onclick="showCreateTagModal()">
                                    + 新規タグ作成
                                </button>
                            </div>
                            <div id="tags-list" class="tags-list">
                                <p class="loading">読み込み中...</p>
                            </div>
                        </div>

                        <div class="settings-divider"></div>

                        <!-- Model Tag Configuration -->
                        <div class="tag-management-section">
                            <div class="tag-section-header">
                                <h4>モデル別許可タグ設定</h4>
                            </div>
                            <p class="settings-hint" style="margin-bottom: 0.75rem;">
                                各モデルで実行可能なプロンプトのタグを設定します。設定されていないモデルはALLタグのみ許可されます。
                            </p>
                            <div id="model-tags-config" class="model-tags-config">
                                <p class="loading">読み込み中...</p>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Database Card -->
                <div class="settings-card settings-card-compact">
                    <div class="settings-card-header">
                        <span class="settings-card-icon">💾</span>
                        <h3>データベース</h3>
                    </div>
                    <div class="settings-card-body">
                        <div class="settings-row">
                            <div class="settings-row-label">
                                <span class="settings-label">データベースパス</span>
                                <span class="settings-label-sub">Database Path</span>
                            </div>
                            <div class="settings-row-control">
                                <code id="db-path" class="db-path-display">database/app.db</code>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Datasets Tab -->
    <div id="tab-datasets" class="tab-content">
        <div class="section">
            <h2>データセット管理 / Dataset Management</h2>
            <button id="btn-import-dataset" class="btn btn-primary">データセットインポート / Import Dataset</button>
        </div>

        <div class="section">
            <h3>データセット一覧 / Datasets</h3>
            <div id="datasets-list">
                <p class="loading">Loading...</p>
            </div>
        </div>
    </div>

    <!-- Agent Tab -->
    <div id="tab-agent" class="tab-content">
        <div class="section">
            <h2>AIエージェント / AI Agent</h2>
            <p style="color: #64748b; margin-bottom: 1rem;">
                自然言語でシステムを操作できます。プロジェクト管理、プロンプト実行、ワークフロー操作などをAIエージェントに依頼できます。
            </p>
        </div>

        <div class="agent-container" style="display: flex; gap: 1rem; height: calc(100vh - 280px); min-height: 500px;">
            <!-- History Panel (Left) -->
            <div class="agent-history-panel" style="width: 220px; min-width: 200px; border: 1px solid #e2e8f0; border-radius: 12px; overflow: hidden; display: flex; flex-direction: column; background: white; box-shadow: 0 1px 3px rgba(0,0,0,0.05);">
                <div class="agent-history-header" style="padding: 0.875rem 1rem; background: linear-gradient(135deg, #f8fafc 0%, #f1f5f9 100%); border-bottom: 1px solid #e2e8f0; display: flex; justify-content: space-between; align-items: center;">
                    <span style="font-weight: 600; color: #334155;">📜 履歴</span>
                    <div style="display: flex; gap: 0.25rem;">
                        <button class="btn btn-sm" style="padding: 0.25rem 0.5rem; font-size: 0.7rem; background: #ef4444; color: white; border: none; border-radius: 4px; cursor: pointer;" onclick="clearAllAgentHistory()" title="全履歴削除">🗑️</button>
                        <button class="btn btn-sm" style="padding: 0.25rem 0.625rem; font-size: 0.75rem; background: #3b82f6; color: white; border: none; border-radius: 6px; cursor: pointer;" onclick="startNewAgentSession()">+ 新規</button>
                    </div>
                </div>
                <!-- Search Box -->
                <div style="padding: 0.5rem 0.625rem; border-bottom: 1px solid #e2e8f0;">
                    <input type="text" id="agent-history-search"
                           placeholder="🔍 履歴を検索..."
                           oninput="filterAgentSessionHistory()"
                           style="width: 100%; padding: 0.375rem 0.5rem; border: 1px solid #e2e8f0; border-radius: 6px; font-size: 0.8rem; outline: none; transition: border-color 0.2s;"
                           onfocus="this.style.borderColor='#3b82f6'" onblur="this.style.borderColor='#e2e8f0'">
                </div>
                <div id="agent-history-list" class="agent-history-list" style="flex: 1; overflow-y: auto; padding: 0.625rem;">
                    <p style="padding: 1rem; color: #94a3b8; font-size: 0.85rem; text-align: center;">履歴がありません</p>
                </div>
            </div>

            <!-- Chat Area (Expanded) -->
            <div class="agent-chat-area" style="flex: 1; display: flex; flex-direction: column; border: 1px solid #e2e8f0; border-radius: 12px; overflow: hidden; background: white; box-shadow: 0 1px 3px rgba(0,0,0,0.05);">
                <div class="agent-chat-header" style="padding: 0.875rem 1rem; background: linear-gradient(135deg, #f8fafc 0%, #f1f5f9 100%); border-bottom: 1px solid #e2e8f0; display: flex; justify-content: space-between; align-items: center;">
                    <span style="font-weight: 600; color: #334155;">💬 チャット</span>
                    <span id="agent-session-id-display" style="font-size: 0.7rem; color: #94a3b8; margin-left: 0.5rem; font-family: monospace; cursor: help;" title="Session ID (デバッグ用)"></span>
                    <div style="display: flex; gap: 0.5rem; align-items: center;">
                        <select id="agent-model-select" style="padding: 0.375rem 0.75rem; border: 1px solid #e2e8f0; border-radius: 6px; font-size: 0.8rem; background: white; color: #475569; cursor: pointer;">
                            <option value="claude-3.5-sonnet">Claude 3.5 Sonnet</option>
                            <option value="claude-sonnet-4">Claude Sonnet 4</option>
                            <option value="azure-gpt-4.1">Azure GPT-4.1</option>
                        </select>
                        <select id="agent-iterations-select" style="padding: 0.375rem 0.5rem; border: 1px solid #e2e8f0; border-radius: 6px; font-size: 0.8rem; background: white; color: #475569; cursor: pointer; min-width: 70px;" title="最大イテレーション数 / Max iterations">
                            <option value="10">10回</option>
                            <option value="20">20回</option>
                            <option value="30">30回</option>
                            <option value="50">50回</option>
                            <option value="70">70回</option>
                            <option value="99">99回</option>
                        </select>
                        <button id="btn-agent-copy-all" class="btn btn-sm btn-outline agent-copy-all-btn" onclick="copyAgentConversation()" title="会話全体をコピー / Copy all">
                            <svg width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><rect x="9" y="9" width="13" height="13" rx="2" ry="2"></rect><path d="M5 15H4a2 2 0 0 1-2-2V4a2 2 0 0 1 2-2h9a2 2 0 0 1 2 2v1"></path></svg>
                        </button>
                        <button id="btn-agent-tools" class="btn btn-sm btn-outline" style="padding: 0.375rem 0.75rem; font-size: 0.8rem; border-radius: 6px; border: 1px solid #cbd5e1; background: white; color: #475569; cursor: pointer;" onclick="showAgentToolsModal()">
                            🔧 ツール
                        </button>
                        <button id="btn-agent-clear" class="btn btn-sm btn-outline" style="padding: 0.375rem 0.75rem; font-size: 0.8rem; border-radius: 6px; border: 1px solid #cbd5e1; background: white; color: #475569; cursor: pointer;" onclick="clearAgentChat()">
                            🗑️ クリア
                        </button>
                    </div>
                </div>
                <div id="agent-messages" class="agent-messages" style="flex: 1; overflow-y: auto; padding: 1.25rem; background: linear-gradient(180deg, #fafbfc 0%, #f8fafc 100%);">
                    <div class="agent-welcome" style="text-align: center; padding: 3rem 2rem; color: #64748b;">
                        <div style="font-size: 4rem; margin-bottom: 1.5rem; filter: drop-shadow(0 4px 6px rgba(0,0,0,0.1));">🤖</div>
                        <p style="font-size: 1.1rem; font-weight: 500; color: #475569; margin-bottom: 0.75rem;">こんにちは！何をお手伝いしましょうか？</p>
                        <p style="font-size: 0.9rem; color: #94a3b8;">例: 「プロジェクト一覧を表示して」「ワークフローを実行して」</p>
                    </div>
                </div>
                <div class="agent-input-area" style="padding: 0.5rem; border-top: 1px solid #e2e8f0; background: white;">
                    <div style="position: relative; width: 100%;">
                        <textarea id="agent-input" class="agent-input" rows="3"
                                  placeholder="メッセージを入力... (Shift+Enterで改行、Enterで送信)"
                                  style="display: block; width: 100%; box-sizing: border-box; padding: 0.75rem 8rem 0.75rem 0.75rem; border: 1px solid #e2e8f0; border-radius: 8px; resize: vertical; font-size: 0.95rem; line-height: 1.5; background: #f8fafc; transition: border-color 0.2s, box-shadow 0.2s; min-height: 70px;"
                                  onfocus="this.style.borderColor='#3b82f6'; this.style.boxShadow='0 0 0 3px rgba(59,130,246,0.1)';"
                                  onblur="this.style.borderColor='#e2e8f0'; this.style.boxShadow='none';"
                                  onkeydown="if(event.key === 'Enter' && !event.shiftKey) { event.preventDefault(); sendAgentMessage(); }"></textarea>
                        <button id="btn-resource-picker" class="btn btn-secondary" onclick="openResourcePicker()" title="リソース参照 / Resource Picker" style="position: absolute; right: 5rem; bottom: 0.375rem; padding: 0.4rem 0.5rem; border-radius: 6px; font-size: 1rem; background: #f1f5f9; border: 1px solid #e2e8f0; cursor: pointer; transition: background 0.2s;">
                            📋
                        </button>
                        <button id="btn-agent-send" class="btn btn-primary" onclick="sendAgentMessage()" style="position: absolute; right: 0.375rem; bottom: 0.375rem; padding: 0.4rem 0.875rem; border-radius: 6px; font-weight: 500; font-size: 0.85rem; background: linear-gradient(135deg, #3b82f6 0%, #2563eb 100%); border: none; color: white; cursor: pointer; box-shadow: 0 2px 4px rgba(59,130,246,0.3); transition: transform 0.1s, box-shadow 0.1s;"
                            onmousedown="this.style.transform='scale(0.98)';"
                            onmouseup="this.style.transform='scale(1)';">
                            送信
                        </button>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

<!-- Modals -->
<div id="modal-overlay" class="modal-overlay">
    <div id="modal-content" class="modal-content">
        <!-- Dynamic modal content -->
    </div>
</div>

<!-- Secondary Modal for Help -->
<div id="modal-overlay-2" class="modal-overlay">
    <div id="modal-content-2" class="modal-content">
        <!-- Dynamic help modal content -->
    </div>
</div>

<!-- Agent Tools Modal -->
<div id="agent-tools-overlay" class="modal-overlay" style="z-index: 1050;">
    <div id="agent-tools-modal" class="modal-content" style="max-width: 700px; max-height: 80vh; display: flex; flex-direction: column; border-radius: 16px; box-shadow: 0 25px 50px -12px rgba(0,0,0,0.25);">
        <div class="modal-header" style="display: flex; justify-content: space-between; align-items: center; padding: 1.25rem 1.5rem; border-bottom: 1px solid #e2e8f0; background: linear-gradient(135deg, #f8fafc 0%, #f1f5f9 100%); border-radius: 16px 16px 0 0;">
            <h3 style="margin: 0; font-size: 1.25rem; font-weight: 600; color: #1e293b; display: flex; align-items: center; gap: 0.5rem;">
                <span style="font-size: 1.5rem;">🔧</span> 利用可能なツール / Available Tools
            </h3>
            <button class="btn btn-secondary" onclick="hideAgentToolsModal()" style="padding: 0.5rem 0.75rem; border: none; background: #e2e8f0; color: #475569; border-radius: 8px; cursor: pointer; font-size: 1rem; line-height: 1;">✕</button>
        </div>
        <div id="agent-tools-list" class="agent-tools-list" style="flex: 1; overflow-y: auto; padding: 1rem 1.5rem; background: white;">
            <p class="loading" style="padding: 2rem; color: #64748b; text-align: center;">Loading tools...</p>
        </div>
        <div class="modal-footer" style="padding: 1rem 1.5rem; border-top: 1px solid #e2e8f0; background: #f8fafc; border-radius: 0 0 16px 16px; text-align: right;">
            <button class="btn btn-primary" onclick="hideAgentToolsModal()" style="padding: 0.625rem 1.25rem; background: linear-gradient(135deg, #3b82f6 0%, #2563eb 100%); color: white; border: none; border-radius: 8px; cursor: pointer; font-weight: 500;">閉じる / Close</button>
        </div>
    </div>
</div>

<!-- Variable Picker Modal -->
<div id="variable-picker-overlay" class="modal-overlay" style="z-index: 1100;">
    <div id="variable-picker-modal" class="vp-modal">
        <!-- Modal Header -->
        <div class="vp-modal-header">
            <div class="vp-modal-title">
                <span class="vp-modal-icon">🔧</span>
                <h3>変数・数式を挿入</h3>
            </div>
            <button class="vp-close-btn" onclick="closeVariablePicker()" title="閉じる">✕</button>
        </div>

        <!-- Composition Area (shared across tabs) -->
        <div class="vp-composition-area">
            <label class="vp-composition-label">
                <span class="vp-label-icon">📝</span>
                作成エリア
            </label>
            <textarea id="vp-composition-input" class="vp-composition-input" rows="2"
                      placeholder="変数をクリックするとここに追加されます"></textarea>
        </div>

        <!-- Tabs -->
        <div class="vp-tabs">
            <button type="button" class="vp-tab active" data-tab="variables" onclick="switchVariablePickerTab('variables')">
                <span class="vp-tab-icon">📥</span> 変数
            </button>
            <button type="button" class="vp-tab" data-tab="formula" onclick="switchVariablePickerTab('formula')">
                <span class="vp-tab-icon">🧮</span> 数式ヘルプ
            </button>
        </div>

        <!-- Variables Tab Content -->
        <div id="vp-tab-variables" class="vp-tab-content active">
            <div class="vp-search-container">
                <span class="vp-search-icon">🔍</span>
                <input type="text" id="variable-search" class="vp-search-input"
                       placeholder="変数・関数を検索..."
                       oninput="filterVariables(this.value)">
            </div>

            <div id="variable-categories" class="vp-categories-container">
                <!-- Categories will be rendered here -->
                <p class="vp-loading">読み込み中...</p>
            </div>

            <div class="vp-hint">
                💡 変数をクリック → 作成エリアに追加 → 「挿入」ボタンで確定
            </div>

            <div class="vp-function-ref-link" onclick="showFunctionReference()">
                <span>📚</span>
                <span>全関数リファレンスを表示 / View All Functions</span>
            </div>
        </div>

        <!-- Formula Help Tab Content -->
        {% raw %}
        <div id="vp-tab-formula" class="vp-tab-content" style="display: none;">
            <div class="vp-formula-help">
                <div class="vp-formula-section">
                    <h4 class="vp-formula-title">
                        <span class="vp-formula-icon">📖</span>
                        利用可能な関数
                    </h4>
                    <div class="vp-formula-function-list">
                        <div class="vp-formula-function">
                            <code>sum(a, b, ...)</code>
                            <span>合計を計算</span>
                        </div>
                    </div>
                </div>

                <div class="vp-formula-section">
                    <h4 class="vp-formula-title">
                        <span class="vp-formula-icon">💡</span>
                        クリックで追加
                    </h4>
                    <div class="vp-formula-examples">
                        <code class="vp-formula-example" onclick="appendToComposition('sum()')">sum()</code>
                        <code class="vp-formula-example" onclick="appendToComposition('sum({{step1.score}}, {{step2.score}})')">sum({{step1.score}}, ...)</code>
                        <code class="vp-formula-example" onclick="appendToComposition('sum({{input.value1}}, {{input.value2}})')">sum({{input.value1}}, ...)</code>
                    </div>
                </div>

                <div class="vp-formula-section">
                    <h4 class="vp-formula-title">
                        <span class="vp-formula-icon">📝</span>
                        数式の書き方
                    </h4>
                    <ol class="vp-formula-steps">
                        <li>変数タブから変数を選択</li>
                        <li>作成エリアで編集（カンマ追加など）</li>
                        <li>sum()で囲むなど関数を適用</li>
                        <li>「挿入」ボタンで確定</li>
                    </ol>
                </div>
            </div>
        </div>
        {% endraw %}

        <!-- Action Buttons (shared) -->
        <div class="vp-actions">
            <button type="button" class="vp-btn vp-btn-primary" onclick="insertCompositionValue()">
                <span class="vp-btn-icon">➕</span> 挿入
            </button>
            <button type="button" class="vp-btn vp-btn-secondary" onclick="clearComposition()">
                <span class="vp-btn-icon">🗑️</span> クリア
            </button>
        </div>
    </div>
</div>

<!-- Resource Picker Modal for AI Agent -->
<div id="resource-picker-overlay" class="modal-overlay" style="z-index: 1100;">
    <div id="resource-picker-modal" class="modal-content" style="max-width: 700px; max-height: 85vh; display: flex; flex-direction: column;">
        <div class="modal-header" style="display: flex; justify-content: space-between; align-items: center; padding-bottom: 1rem; border-bottom: 1px solid #ddd;">
            <h3 style="margin: 0;">📋 リソース参照</h3>
            <button class="btn btn-secondary" onclick="closeResourcePicker()">✕</button>
        </div>

        <!-- Search Area -->
        <div style="padding: 0.25rem 0;">
            <input type="text" id="resource-search" placeholder="🔍 検索... / Search..."
                   style="width: 100%; padding: 0.5rem; border: 1px solid #ccc; border-radius: 4px; font-size: 0.95rem;"
                   oninput="filterResources(this.value)">
        </div>

        <!-- Project Filter (shown for non-project tabs) -->
        <div id="resource-project-filter" style="padding: 0.25rem 0;">
            <select id="resource-project-select"
                    style="width: 100%; padding: 0.375rem; border: 1px solid #e2e8f0; border-radius: 4px; font-size: 0.9rem;"
                    onchange="onResourceProjectChange()">
                <option value="">-- 全プロジェクト / All Projects --</option>
            </select>
        </div>

        <!-- Tabs -->
        <div class="rp-tabs" style="display: flex; gap: 0.25rem; margin-bottom: 0.25rem; border-bottom: 1px solid #e2e8f0; padding-bottom: 0.25rem;">
            <button type="button" class="rp-tab active" data-tab="datasets" onclick="switchResourceTab('datasets')" style="padding: 0.5rem 1rem; border: none; background: #3b82f6; color: white; border-radius: 4px 4px 0 0; cursor: pointer; font-size: 0.85rem;">
                📊 データセット
            </button>
            <button type="button" class="rp-tab" data-tab="workflows" onclick="switchResourceTab('workflows')" style="padding: 0.5rem 1rem; border: none; background: #f1f5f9; color: #475569; border-radius: 4px 4px 0 0; cursor: pointer; font-size: 0.85rem;">
                ⚡ ワークフロー
            </button>
            <button type="button" class="rp-tab" data-tab="prompts" onclick="switchResourceTab('prompts')" style="padding: 0.5rem 1rem; border: none; background: #f1f5f9; color: #475569; border-radius: 4px 4px 0 0; cursor: pointer; font-size: 0.85rem;">
                📝 プロンプト
            </button>
            <button type="button" class="rp-tab" data-tab="projects" onclick="switchResourceTab('projects')" style="padding: 0.5rem 1rem; border: none; background: #f1f5f9; color: #475569; border-radius: 4px 4px 0 0; cursor: pointer; font-size: 0.85rem;">
                📁 プロジェクト
            </button>
        </div>

        <!-- Resource List -->
        <div id="resource-list" style="flex: 1; overflow-y: auto; border: 1px solid #ddd; border-radius: 4px; min-height: 250px; max-height: 350px;">
            <p style="padding: 1rem; color: #7f8c8d;">読み込み中... / Loading...</p>
        </div>

        <!-- Dataset Column Selector (shown only for datasets) -->
        <div id="dataset-column-selector" style="display: none; margin-top: 0.5rem; padding: 0.5rem; background: #f8fafc; border-radius: 4px;">
            <label style="font-size: 0.85rem; font-weight: 500; color: #475569;">📊 カラム選択 (任意):</label>
            <select id="dataset-column-select" style="width: 100%; padding: 0.375rem; border: 1px solid #e2e8f0; border-radius: 4px; margin-top: 0.25rem;">
                <option value="">-- 全カラム / All columns --</option>
            </select>
        </div>

        <!-- Usage Guide -->
        <div style="padding: 0.25rem 0; font-size: 0.8rem; color: #64748b;">
            💡 挿入形式: <code style="background: #f1f5f9; padding: 2px 4px; border-radius: 3px;">dataset:ID # 名前</code> /
            <code style="background: #f1f5f9; padding: 2px 4px; border-radius: 3px;">workflow:ID # 名前</code>
        </div>

        <!-- Action Buttons -->
        <div style="display: flex; gap: 0.5rem; padding-top: 0.25rem; border-top: 1px solid #e2e8f0;">
            <button type="button" class="btn btn-secondary" onclick="closeResourcePicker()" style="flex: 1;">
                閉じる / Close
            </button>
        </div>
    </div>
</div>

<!-- Workflow Reference Modal -->
<div id="workflow-reference-overlay" class="modal-overlay" style="z-index: 1200;">
    <div id="workflow-reference-modal" class="modal-content" style="max-width: 900px; max-height: 90vh; display: flex; flex-direction: column;">
        <div class="modal-header" style="display: flex; justify-content: space-between; align-items: center; padding-bottom: 1rem; border-bottom: 1px solid #ddd;">
            <h3 style="margin: 0;">📖 ワークフロー リファレンス / Workflow Reference</h3>
            <div style="display: flex; gap: 0.5rem;">
                <button class="btn btn-secondary" onclick="copyWorkflowReference()" title="コピー">📋 コピー</button>
                <button class="btn btn-secondary" onclick="closeWorkflowReference()">✕</button>
            </div>
        </div>

        <div style="flex: 1; overflow-y: auto; padding: 1rem 0;">
            {% raw %}
            <div id="workflow-reference-content" style="font-family: monospace; font-size: 0.85rem; line-height: 1.6; white-space: pre-wrap; background: #f8f9fa; padding: 1rem; border-radius: 4px;">
# ワークフロー JSON リファレンス / Workflow JSON Reference

このドキュメントをLLMに読み込ませることで、ワークフローJSONの作成を支援できます。
Feed this document to an LLM to help create workflow JSON.

## 1. JSON基本構造 / Basic JSON Structure

```json
{
  "version": "1.0",
  "name": "ワークフロー名",
  "description": "説明文",
  "auto_context": false,
  "steps": [
    {
      "step_order": 1,
      "step_name": "step1",
      "step_type": "prompt",
      "prompt_name": "プロンプト名",
      "execution_mode": "sequential",
      "input_mapping": {"param": "{{input.value}}"},
      "condition_config": null
    }
  ]
}
```

## 2. ステップタイプ / Step Types

### prompt (LLM実行)
```json
{
  "step_type": "prompt",
  "prompt_name": "分析プロンプト",
  "input_mapping": {
    "text": "{{input.text}}",
    "context": "{{step1.result}}"
  }
}
```

### set (変数設定)
```json
{
  "step_type": "set",
  "condition_config": {
    "variable": "count",
    "value": "0"
  }
}
```
- 変数は {{vars.変数名}} で参照
- 関数も使用可: "value": "sum({{vars.a}}, {{vars.b}})"

### if / elif / else / endif (条件分岐)
```json
{"step_type": "if", "condition_config": {"condition": "{{vars.score}} > 80"}},
{"step_type": "prompt", "prompt_name": "高評価処理"},
{"step_type": "elif", "condition_config": {"condition": "{{vars.score}} > 50"}},
{"step_type": "prompt", "prompt_name": "中評価処理"},
{"step_type": "else"},
{"step_type": "prompt", "prompt_name": "低評価処理"},
{"step_type": "endif"}
```

### loop / endloop (条件ループ)
```json
{"step_type": "set", "condition_config": {"variable": "i", "value": "0"}},
{"step_type": "loop", "condition_config": {"condition": "{{vars.i}} < 3", "max_iterations": 10}},
{"step_type": "prompt", "prompt_name": "繰り返し処理"},
{"step_type": "set", "condition_config": {"variable": "i", "value": "sum({{vars.i}}, 1)"}},
{"step_type": "endloop"}
```

### foreach / endforeach (リストループ)
```json
{"step_type": "foreach", "condition_config": {"list": "{{step1.items}}", "item_var": "item", "index_var": "idx"}},
{"step_type": "prompt", "prompt_name": "各アイテム処理", "input_mapping": {"item": "{{vars.item}}"}},
{"step_type": "endforeach"}
```

### break / continue (ループ制御)
```json
{"step_type": "if", "condition_config": {"condition": "{{vars.score}} < 0"}},
{"step_type": "break"},
{"step_type": "endif"}
```

### output (結果出力)
```json
{
  "step_type": "output",
  "condition_config": {
    "output_type": "screen",
    "columns": ["日付", "結果", "スコア"],
    "values": ["{{vars.date}}", "{{step1.result}}", "{{vars.score}}"],
    "append": false
  }
}
```
- **output_type**: "screen" (画面表示) or "file" (ファイル出力)
- **format**: "csv" or "tsv" (ファイル出力時)
- **columns**: カラム名の配列
- **values**: 各カラムの値 (変数参照可)
- **append**: true = 追記モード (FOREACHループ内で有用)
- ファイル出力時は結果タブからダウンロード可能

## 3. 変数参照 / Variable References

| 構文 | 説明 | 例 |
|------|------|-----|
| {{input.パラメータ名}} | 初期入力値 | {{input.text}} |
| {{ステップ名.フィールド}} | ステップ出力 | {{step1.result}} |
| {{vars.変数名}} | SET変数 | {{vars.count}} |
| {{vars.item}} | FOREACHアイテム | {{vars.item}} |
| {{vars.idx}} | FOREACHインデックス | {{vars.idx}} |

## 4. 文字列関数 / String Functions

### 変換系
| 関数 | 説明 | 例 |
|------|------|-----|
| upper(s) | 大文字変換 | upper({{step1.text}}) → "HELLO" |
| lower(s) | 小文字変換 | lower({{step1.text}}) → "hello" |
| capitalize(s) | 先頭大文字 | capitalize(hello) → "Hello" |
| title(s) | 各単語先頭大文字 | title(hello world) → "Hello World" |
| reverse(s) | 文字列反転 | reverse(abc) → "cba" |

### 空白処理
| 関数 | 説明 | 例 |
|------|------|-----|
| trim(s) | 前後空白削除 | trim("  text  ") → "text" |
| lstrip(s) | 先頭空白削除 | lstrip("  text") → "text" |
| rstrip(s) | 末尾空白削除 | rstrip("text  ") → "text" |

### 部分文字列
| 関数 | 説明 | 例 |
|------|------|-----|
| slice(s, start, end) | 部分抽出 | slice(Hello, 0, 2) → "He" |
| left(s, n) | 先頭N文字 | left(Hello, 3) → "Hel" |
| right(s, n) | 末尾N文字 | right(Hello, 2) → "lo" |

### 変更系
| 関数 | 説明 | 例 |
|------|------|-----|
| replace(s, old, new) | 置換 | replace(hello, l, L) → "heLLo" |
| repeat(s, n) | 繰り返し | repeat(ab, 3) → "ababab" |

### 配列操作
| 関数 | 説明 | 例 |
|------|------|-----|
| split(s, delim) | 分割→JSON配列 | split(a;b;c, ;) → ["a","b","c"] |
| join(arr, delim) | 配列→文字列結合 | join(["a","b"], -) → "a-b" |
| concat(s1, s2, ...) | 連結 | concat(a, b, c) → "abc" |

### 条件/チェック
| 関数 | 説明 | 例 |
|------|------|-----|
| default(s, def) | 空ならデフォルト値 | default({{x}}, N/A) → "N/A" |
| contains(s, sub) | 含むか | contains(Hello, ell) → "true" |
| startswith(s, pre) | 先頭一致 | startswith(Hello, He) → "true" |
| endswith(s, suf) | 末尾一致 | endswith(Hello, lo) → "true" |
| count(s, sub) | 出現回数 | count(Hello, l) → 2 |

### 数値/長さ
| 関数 | 説明 | 例 |
|------|------|-----|
| length(s) | 文字数 | length(Hello) → 5 |
| sum(a, b, ...) | 合計 | sum(1, 2, 3) → 6 |

### 特殊
| 関数 | 説明 | 例 |
|------|------|-----|
| shuffle(s, delim) | シャッフル | shuffle(a;b;c, ;) → "c;a;b" (ランダム) |
| debug(s1, s2, ...) | デバッグ出力 | debug({{x}}, {{y}}) → "val1 \| val2" |

### 日時 / Date & Time
| 関数 | 説明 | 例 |
|------|------|-----|
| now(fmt) | 現在日時 | now(%Y-%m-%d %H:%M:%S) → "2025-01-15 14:30:45" |
| today(fmt) | 今日の日付 | today(%Y/%m/%d) → "2025/01/15" |
| time(fmt) | 現在時刻 | time(%H:%M) → "14:30" |

- フォーマットはPython strftime形式
- 主なフォーマット指定子: %Y(年4桁), %m(月), %d(日), %H(時), %M(分), %S(秒)
- 例: now(%Y年%m月%d日) → "2025年01月15日"

## 5. 条件式の演算子 / Condition Operators

| 演算子 | 説明 | 例 |
|--------|------|-----|
| == | 等しい | {{vars.x}} == 10 |
| != | 等しくない | {{vars.x}} != 0 |
| > | より大きい | {{vars.score}} > 80 |
| >= | 以上 | {{vars.score}} >= 60 |
| < | より小さい | {{vars.count}} < 5 |
| <= | 以下 | {{vars.count}} <= 10 |
| && | AND | {{vars.a}} > 0 && {{vars.b}} > 0 |
| \|\| | OR | {{vars.x}} == 1 \|\| {{vars.y}} == 1 |

## 6. 完全なワークフロー例 / Complete Workflow Example

```json
{
  "version": "1.0",
  "name": "品質チェック付き文章生成",
  "description": "文章を生成し、品質スコアが80以上になるまで再生成",
  "auto_context": false,
  "steps": [
    {
      "step_order": 1,
      "step_name": "init",
      "step_type": "set",
      "condition_config": {"variable": "attempt", "value": "0"}
    },
    {
      "step_order": 2,
      "step_name": "init_score",
      "step_type": "set",
      "condition_config": {"variable": "score", "value": "0"}
    },
    {
      "step_order": 3,
      "step_name": "loop_start",
      "step_type": "loop",
      "condition_config": {"condition": "{{vars.score}} < 80 && {{vars.attempt}} < 3", "max_iterations": 5}
    },
    {
      "step_order": 4,
      "step_name": "generate",
      "step_type": "prompt",
      "prompt_name": "文章生成",
      "input_mapping": {"topic": "{{input.topic}}", "attempt": "{{vars.attempt}}"}
    },
    {
      "step_order": 5,
      "step_name": "evaluate",
      "step_type": "prompt",
      "prompt_name": "品質評価",
      "input_mapping": {"text": "{{generate.text}}"}
    },
    {
      "step_order": 6,
      "step_name": "update_score",
      "step_type": "set",
      "condition_config": {"variable": "score", "value": "{{evaluate.score}}"}
    },
    {
      "step_order": 7,
      "step_name": "increment",
      "step_type": "set",
      "condition_config": {"variable": "attempt", "value": "sum({{vars.attempt}}, 1)"}
    },
    {
      "step_order": 8,
      "step_name": "loop_end",
      "step_type": "endloop"
    },
    {
      "step_order": 9,
      "step_name": "check_success",
      "step_type": "if",
      "condition_config": {"condition": "{{vars.score}} >= 80"}
    },
    {
      "step_order": 10,
      "step_name": "success_msg",
      "step_type": "set",
      "condition_config": {"variable": "status", "value": "成功"}
    },
    {
      "step_order": 11,
      "step_name": "else_branch",
      "step_type": "else"
    },
    {
      "step_order": 12,
      "step_name": "fail_msg",
      "step_type": "set",
      "condition_config": {"variable": "status", "value": "再試行上限到達"}
    },
    {
      "step_order": 13,
      "step_name": "endif_branch",
      "step_type": "endif"
    }
  ]
}
```

## 7. 注意事項 / Notes

- prompt_name はシステム内のプロンプト名と完全一致が必要
- step_order は1から連番で指定
- step_name は英数字とアンダースコアを推奨
- 関数の引数区切りはカンマ（split/joinのデリミタにはカンマ以外を推奨）
- 条件式内の文字列比較は引用符不要
            </div>
            {% endraw %}
        </div>
    </div>
</div>

<!-- Draggable Prompt Editor Window -->
<div id="prompt-editor-window" class="draggable-window" style="display: none;">
    <div class="draggable-header" id="prompt-editor-header">
        <span class="draggable-title">📝 プロンプト編集 / Prompt Editor</span>
        <div class="draggable-controls">
            <button type="button" class="btn-minimize" onclick="minimizePromptEditor()" title="最小化">−</button>
            <button type="button" class="btn-close" onclick="closePromptEditor()" title="閉じる">×</button>
        </div>
    </div>
    <div class="draggable-body" id="prompt-editor-body">
        <input type="hidden" id="prompt-editor-prompt-id">
        <input type="hidden" id="prompt-editor-step-number">
        <input type="hidden" id="prompt-editor-current-revision">
        <input type="hidden" id="prompt-editor-project-id">

        <!-- Prompt Selector and New Prompt Button -->
        <div style="display: flex; gap: 0.5rem; align-items: center; margin-bottom: 0.8rem; padding-bottom: 0.8rem; border-bottom: 1px solid #e0e0e0;">
            <label style="font-size: 0.85rem; font-weight: bold; white-space: nowrap;">プロンプト:</label>
            <select id="prompt-editor-prompt-selector" onchange="onPromptEditorPromptChange(this.value)" style="flex: 1; padding: 0.4rem; border: 1px solid #ccc; border-radius: 4px;">
                <option value="">-- 読み込み中 --</option>
            </select>
            <button type="button" class="btn btn-success btn-sm" onclick="showCreatePromptInEditor()" style="white-space: nowrap; padding: 0.4rem 0.8rem;">
                ＋ 新規作成
            </button>
            <button type="button" class="btn btn-info btn-sm" onclick="duplicatePromptFromEditor()" style="white-space: nowrap; padding: 0.4rem 0.6rem;" title="複製 / Duplicate">
                📋
            </button>
            <button type="button" class="btn btn-danger btn-sm" id="prompt-editor-delete-btn" onclick="deletePromptFromEditor()" style="white-space: nowrap; padding: 0.4rem 0.6rem;" title="削除 / Delete">
                🗑
            </button>
        </div>

        <!-- Prompt Metadata Editing Section -->
        <div class="prompt-editor-metadata" style="margin-bottom: 1rem; padding: 0.8rem; background: #f8f9fa; border-radius: 6px; border: 1px solid #e0e0e0;">
            <div style="display: flex; gap: 1rem; align-items: flex-start; flex-wrap: wrap;">
                <div style="flex: 1; min-width: 200px;">
                    <label for="prompt-editor-name" style="font-size: 0.85rem; font-weight: bold; display: block; margin-bottom: 0.3rem;">
                        プロンプト名 / Name:
                    </label>
                    <input type="text" id="prompt-editor-name"
                           style="width: 100%; padding: 0.4rem 0.6rem; border: 1px solid #ccc; border-radius: 4px; font-size: 0.9rem;"
                           placeholder="プロンプト名を入力">
                </div>
                <div style="flex: 2; min-width: 300px;">
                    <label for="prompt-editor-description" style="font-size: 0.85rem; font-weight: bold; display: block; margin-bottom: 0.3rem;">
                        説明 / Description:
                    </label>
                    <input type="text" id="prompt-editor-description"
                           style="width: 100%; padding: 0.4rem 0.6rem; border: 1px solid #ccc; border-radius: 4px; font-size: 0.9rem;"
                           placeholder="プロンプトの説明（任意）">
                </div>
                <div style="display: flex; align-items: flex-end; gap: 0.8rem;">
                    <span id="prompt-editor-id-info" style="color: #aaa; font-size: 0.75rem; padding-bottom: 0.5rem;"></span>
                    <span id="prompt-editor-revision-info" style="color: #7f8c8d; font-size: 0.85rem; padding-bottom: 0.5rem;"></span>
                </div>
            </div>
            <!-- Tag Selector Section -->
            <div style="margin-top: 0.8rem; padding-top: 0.8rem; border-top: 1px solid #e0e0e0;">
                <label style="font-size: 0.85rem; font-weight: bold; display: block; margin-bottom: 0.4rem;">
                    タグ / Tags:
                </label>
                <div id="prompt-editor-tags" class="prompt-editor-tags-container">
                    <div id="prompt-editor-current-tags" class="prompt-current-tags">
                        <!-- Dynamic tag chips will be inserted here -->
                    </div>
                    <button type="button" class="btn-add-prompt-tag" onclick="showPromptEditorTagDropdown(this)">+ タグ追加</button>
                </div>
            </div>
        </div>

        <!-- Prompt/Parser Tab Navigation -->
        <div class="prompt-editor-tabs">
            <button type="button" class="prompt-tab-btn active" data-tab="prompt" onclick="switchPromptEditorTab('prompt')">
                プロンプト
            </button>
            <button type="button" class="prompt-tab-btn" data-tab="parser" onclick="switchPromptEditorTab('parser')">
                パーサー
            </button>
        </div>

        <div class="prompt-editor-content">
            <!-- Prompt Tab -->
            <div id="prompt-editor-tab-prompt" class="prompt-editor-tab-content active">
                <div class="prompt-editor-main">
                    <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 0.5rem;">
                        <label style="margin: 0;">プロンプトテンプレート / Prompt Template:</label>
                        <div class="role-marker-buttons" style="display: flex; gap: 0.3rem; align-items: center;">
                            <span style="font-size: 0.75rem; color: #7f8c8d; margin-right: 0.3rem;">ロールマーカー:</span>
                            <button type="button" class="btn-marker btn-marker-system" onclick="insertRoleMarker('SYSTEM')" title="[SYSTEM] システム指示を挿入">
                                [SYSTEM]
                            </button>
                            <button type="button" class="btn-marker btn-marker-user" onclick="insertRoleMarker('USER')" title="[USER] ユーザー入力を挿入">
                                [USER]
                            </button>
                            <button type="button" class="btn-marker btn-marker-assistant" onclick="insertRoleMarker('ASSISTANT')" title="[ASSISTANT] アシスタント応答を挿入">
                                [ASSISTANT]
                            </button>
                            <button type="button" class="btn-marker-help" onclick="showRoleMarkerHelp()" title="ロールマーカーのヘルプ">
                                ❓
                            </button>
                        </div>
                    </div>
                    <textarea id="prompt-editor-template"></textarea>
                </div>
            </div>

            <!-- Parser Tab -->
            <div id="prompt-editor-tab-parser" class="prompt-editor-tab-content" style="display: none;">
                <div class="prompt-editor-main">
                    <label>パーサータイプ / Parser Type:</label>
                    <select id="prompt-editor-parser-type" onchange="onPromptEditorParserTypeChange()">
                        <option value="none">なし / None</option>
                        <option value="json">JSON (フィールド抽出)</option>
                        <option value="json_path">JSON Path</option>
                        <option value="regex">正規表現 / Regex</option>
                        <option value="csv_template">CSV Template</option>
                    </select>

                    <label style="margin-top: 1rem; display: block;">パーサー設定 (JSON):</label>
                    <textarea id="prompt-editor-parser-config" style="width: 100%; min-height: 150px; font-family: monospace; font-size: 0.85rem; flex: 1;" placeholder='{"type": "none"}'></textarea>
                    <div style="display: flex; justify-content: space-between; align-items: center; margin-top: 0.3rem;">
                        <small style="color: #7f8c8d;">例: {"type": "json_path", "paths": {"field1": "$.data.value"}}</small>
                        <button type="button" id="json-csv-toggle-btn-workflow" onclick="toggleJsonCsvConverter('-workflow')" style="font-size: 0.75rem; padding: 2px 8px; background: transparent; border: 1px solid #9b59b6; color: #9b59b6; border-radius: 3px; cursor: pointer;">JSON→CSV</button>
                    </div>
                    <!-- Inline JSON to CSV Converter (Workflow Editor) -->
                    <div id="json-csv-converter-section-workflow" style="margin-top: 10px; border: 1px solid #9b59b6; border-radius: 5px; display: none;">
                        <div style="background: #9b59b6; color: white; padding: 8px 12px; display: flex; justify-content: space-between; align-items: center;">
                            <span style="font-weight: bold;">📊 JSON → CSV 変換</span>
                            <button onclick="toggleJsonCsvConverter('-workflow')" style="background: transparent; border: 1px solid white; color: white; padding: 2px 8px; border-radius: 3px; cursor: pointer; font-size: 0.8rem;">閉じる</button>
                        </div>
                        <div style="padding: 10px;">
                            <div style="display: flex; gap: 10px;">
                                <div style="flex: 1;">
                                    <label style="font-size: 0.85rem; font-weight: bold; display: block; margin-bottom: 3px;">サンプルJSON入力:</label>
                                    <textarea id="json-sample-input-workflow" rows="6" style="font-family: 'Courier New', monospace; width: 100%; font-size: 0.85rem;" placeholder='{"field1": "value", "field2": {"nested": "data"}}'></textarea>
                                </div>
                                <div style="display: flex; flex-direction: column; justify-content: center; gap: 5px;">
                                    <button onclick="convertJsonToCsvTemplateInline('-workflow')" style="background: #9b59b6; color: white; border: none; padding: 8px 12px; border-radius: 3px; cursor: pointer; font-size: 0.85rem;">🔄 変換</button>
                                    <button onclick="applyGeneratedParserConfigInline('-workflow')" style="background: #27ae60; color: white; border: none; padding: 8px 12px; border-radius: 3px; cursor: pointer; font-size: 0.85rem;">✅ 適用</button>
                                </div>
                                <div style="flex: 1;">
                                    <label style="font-size: 0.85rem; font-weight: bold; display: block; margin-bottom: 3px;">生成された設定:</label>
                                    <textarea id="generated-parser-config-inline-workflow" rows="6" style="font-family: 'Courier New', monospace; width: 100%; font-size: 0.85rem; background: #f8f9fa;" readonly placeholder="変換結果がここに表示されます"></textarea>
                                </div>
                            </div>
                            <div style="margin-top: 5px;">
                                <label style="font-size: 0.85rem; font-weight: bold;">CSVヘッダープレビュー:</label>
                                <input type="text" id="csv-header-preview-inline-workflow" readonly style="width: 100%; font-family: 'Courier New', monospace; font-size: 0.85rem; background: #f8f9fa; padding: 4px;" placeholder="ヘッダーがここに表示されます">
                            </div>
                        </div>
                    </div>
                </div>
            </div>

            <div class="prompt-editor-sidebar">
                <div class="revision-header">
                    <span>📜 リビジョン</span>
                    <button type="button" class="btn btn-sm" onclick="loadPromptRevisions()" title="更新" style="padding: 2px 6px; font-size: 0.7rem;">🔄</button>
                </div>
                <ul class="revision-list" id="prompt-editor-revisions">
                    <li style="padding: 0.5rem; color: #9e9e9e; font-size: 0.8rem;">読み込み中...</li>
                </ul>
            </div>
        </div>
        <div class="prompt-editor-actions">
            <button type="button" class="btn btn-primary" onclick="savePromptFromEditor()">💾 保存 / Save</button>
            <button type="button" class="btn btn-secondary" onclick="closePromptEditor()">閉じる / Close</button>
            <span id="prompt-editor-status" style="margin-left: 1rem; color: #7f8c8d;"></span>
        </div>
    </div>
</div>

<!-- Workflow JSON Editor Modal -->
<div id="workflow-json-editor-overlay" class="modal-overlay" style="z-index: 1300;">
    <div id="workflow-json-editor-modal" class="modal-content" style="max-width: 1000px; max-height: 90vh; display: flex; flex-direction: column;">
        <div class="modal-header" style="display: flex; justify-content: space-between; align-items: center; padding-bottom: 1rem; border-bottom: 1px solid #ddd;">
            <h3 style="margin: 0;">JSON Editor - <span id="workflow-json-editor-title"></span></h3>
            <div style="display: flex; gap: 0.5rem;">
                <button class="btn btn-secondary" onclick="formatWorkflowJson()" title="整形">Format</button>
                <button class="btn btn-secondary" onclick="closeWorkflowJsonEditor()">×</button>
            </div>
        </div>

        <div style="flex: 1; overflow-y: auto; padding: 1rem 0;">
            <textarea id="workflow-json-editor-content"
                      style="width: 100%; height: 500px; font-family: 'Courier New', monospace; font-size: 0.85rem; line-height: 1.5; padding: 1rem; border: 1px solid #ccc; border-radius: 4px; resize: vertical;"
                      spellcheck="false"></textarea>
            <div id="workflow-json-editor-error" style="color: #e74c3c; margin-top: 0.5rem; font-size: 0.85rem; display: none;"></div>
        </div>

        <div style="display: flex; justify-content: flex-end; gap: 0.5rem; padding-top: 1rem; border-top: 1px solid #ddd;">
            <button class="btn btn-primary" onclick="saveWorkflowJson()">保存 / Save</button>
            <button class="btn btn-secondary" onclick="closeWorkflowJsonEditor()">キャンセル / Cancel</button>
        </div>
    </div>
</div>

<!-- Dataset Column Edit Modal -->
<div id="dataset-columns-overlay" class="modal-overlay" style="z-index: 1300;">
    <div id="dataset-columns-modal" class="modal-content" style="max-width: 600px; max-height: 80vh; display: flex; flex-direction: column;">
        <div class="modal-header" style="display: flex; justify-content: space-between; align-items: center; padding-bottom: 1rem; border-bottom: 1px solid #ddd;">
            <h3 style="margin: 0;">列名の編集 / Edit Column Names</h3>
            <button class="btn btn-secondary" onclick="closeDatasetColumnsModal()">×</button>
        </div>

        <div style="flex: 1; overflow-y: auto; padding: 1rem 0;">
            <div id="column-edit-list" style="display: flex; flex-direction: column; gap: 0.75rem;">
                <!-- Column inputs will be added dynamically -->
            </div>
            <p style="margin-top: 1rem; font-size: 0.85rem; color: #666;">
                ※ 空白・特殊文字はアンダースコアに変換されます
            </p>
        </div>

        <div style="display: flex; justify-content: flex-end; gap: 0.5rem; padding-top: 1rem; border-top: 1px solid #ddd;">
            <button class="btn btn-primary" onclick="saveDatasetColumns()">保存 / Save</button>
            <button class="btn btn-secondary" onclick="closeDatasetColumnsModal()">キャンセル / Cancel</button>
        </div>
    </div>
</div>

<!-- Function Reference Modal -->
<div id="function-reference-overlay" class="modal-overlay" style="z-index: 1400;">
    <div id="function-reference-modal" class="modal-content" style="max-width: 900px; max-height: 90vh; display: flex; flex-direction: column;">
        <div class="modal-header" style="display: flex; justify-content: space-between; align-items: center; padding-bottom: 1rem; border-bottom: 1px solid #ddd;">
            <h3 style="margin: 0; display: flex; align-items: center; gap: 0.5rem;">
                <span style="font-size: 1.5rem;">📚</span>
                関数リファレンス / Function Reference
            </h3>
            <button class="btn btn-secondary" onclick="closeFunctionReference()" style="font-size: 1.5rem; padding: 0.25rem 0.75rem; line-height: 1;">&times;</button>
        </div>

        <div style="padding: 0.75rem 0; border-bottom: 1px solid #e5e7eb;">
            <input type="text" id="function-reference-search" placeholder="関数を検索... / Search functions..."
                   style="width: 100%; padding: 0.5rem 1rem; border: 1px solid #ddd; border-radius: 6px; font-size: 0.9rem;"
                   oninput="filterFunctionReference(this.value)">
        </div>

        <div id="function-reference-content" style="flex: 1; overflow-y: auto; padding: 1rem 0;">
            <!-- Function list will be loaded dynamically -->
            <div style="text-align: center; padding: 2rem; color: #666;">
                読み込み中... / Loading...
            </div>
        </div>

        <div style="display: flex; justify-content: space-between; align-items: center; padding-top: 1rem; border-top: 1px solid #ddd;">
            <span style="color: #666; font-size: 0.85rem;">
                <span id="function-reference-count">0</span> 関数 / functions
            </span>
            <button class="btn btn-secondary" onclick="closeFunctionReference()">閉じる / Close</button>
        </div>
    </div>
</div>

{% endblock %}

{% block scripts %}
<script src="/static/js/app.js?v=20251227_prompt_name_sync"></script>
{% endblock %}
