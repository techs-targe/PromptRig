{% extends "base.html" %}

{% block title %}ãƒ—ãƒ­ãƒ³ãƒ—ãƒˆè©•ä¾¡ã‚·ã‚¹ãƒ†ãƒ  - Prompt Evaluation System{% endblock %}

{% block content %}
<div class="container">
    <!-- Tab Navigation -->
    <div class="tab-navigation">
        <button class="tab-button active" data-tab="single">å˜ç™ºå®Ÿè¡Œ / Single Execution</button>
        <button class="tab-button" data-tab="batch">ãƒãƒƒãƒå®Ÿè¡Œ / Batch Execution</button>
        <button class="tab-button" data-tab="projects">ãƒ—ãƒ­ã‚¸ã‚§ã‚¯ãƒˆè¨­å®š / Projects</button>
        <button class="tab-button" data-tab="settings">ã‚·ã‚¹ãƒ†ãƒ è¨­å®š / System Settings</button>
        <button class="tab-button" data-tab="datasets">ãƒ‡ãƒ¼ã‚¿ã‚»ãƒƒãƒˆ / Datasets</button>
    </div>

    <!-- Tab Content Areas -->

    <!-- Single Execution Tab -->
    <div id="tab-single" class="tab-content active">
        <div class="section">
            <h2>å˜ç™ºå®Ÿè¡Œ / Single Execution</h2>
            <div class="toolbar">
                <label>ãƒ—ãƒ­ã‚¸ã‚§ã‚¯ãƒˆ / Project:</label>
                <select id="single-project-select">
                    <option value="">Loading...</option>
                </select>
                <button id="btn-edit-prompt" class="btn btn-secondary">ãƒ—ãƒ­ãƒ³ãƒ—ãƒˆç·¨é›† / Edit Prompt</button>
                <button id="btn-edit-parser" class="btn btn-secondary">ãƒ‘ãƒ¼ã‚µãƒ¼ç·¨é›† / Edit Parser</button>
                <label style="margin-left: 20px;">ãƒ¢ãƒ‡ãƒ« / Model:</label>
                <select id="model-select">
                    <option value="azure-gpt-4.1">Azure GPT-4.1</option>
                    <option value="openai-gpt-4.1-nano">OpenAI GPT-4.1-nano</option>
                </select>
            </div>
        </div>

        <div class="main-content">
            <div class="left-pane">
                <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 0.5rem;">
                    <h3 style="margin: 0;">å®Ÿè¡Œå±¥æ­´ / History</h3>
                    <button id="btn-reload-single-history" class="btn btn-secondary btn-sm" style="padding: 0.2rem 0.5rem; font-size: 0.75rem;">ğŸ”„</button>
                </div>
                <div id="history-list" class="history-list">
                    <p class="loading">Loading...</p>
                </div>
            </div>

            <div class="right-pane">
                <div class="section">
                    <h3>ãƒ—ãƒ­ãƒ³ãƒ—ãƒˆãƒ†ãƒ³ãƒ—ãƒ¬ãƒ¼ãƒˆ / Prompt Template</h3>
                    <div class="prompt-template-box">
                        <pre id="prompt-template">Loading...</pre>
                    </div>
                </div>

                <div class="section">
                    <h3>å…¥åŠ›ãƒ‘ãƒ©ãƒ¡ãƒ¼ã‚¿ / Input Parameters</h3>
                    <div style="margin-bottom: 0.5rem;">
                        <button type="button" id="btn-select-from-dataset" class="btn btn-secondary" onclick="showDatasetSelectorForSingle()">
                            ğŸ“‹ ãƒ‡ãƒ¼ã‚¿ã‚»ãƒƒãƒˆã‹ã‚‰é¸æŠ / Select from Dataset
                        </button>
                    </div>
                    <form id="input-form">
                        <div id="parameter-inputs">
                            <p class="loading">Loading...</p>
                        </div>

                        <div class="execution-controls">
                            <button type="button" id="btn-send-once" class="btn btn-primary">
                                1ä»¶é€ä¿¡ / Send Once
                            </button>
                            <div class="repeat-control">
                                <label for="repeat-count">å›æ•° / Repeat:</label>
                                <input type="number" id="repeat-count" min="1" max="10" value="3">
                                <button type="button" id="btn-send-repeat" class="btn btn-secondary">
                                    nå›é€ä¿¡ / Send n Times
                                </button>
                                <label style="margin-left: 1rem;">
                                    <input type="checkbox" id="single-include-csv-header" checked>
                                    CSVãƒ˜ãƒƒãƒ€ã‚’ï¼‘è¡Œç›®ã®ã¿ã«å«ã‚ã‚‹ / Include CSV header in first row only
                                </label>
                            </div>
                            <button type="button" id="btn-stop-single" class="btn btn-danger" style="display: none; margin-left: 1rem;">
                                â¹ åœæ­¢ / Stop
                            </button>
                        </div>

                        <div id="execution-status" class="status-message"></div>
                    </form>
                </div>

                <div class="section">
                    <h3>å®Ÿè¡Œçµæœ / Results</h3>
                    <div id="results-area">
                        <p class="info">å®Ÿè¡ŒçµæœãŒã“ã“ã«è¡¨ç¤ºã•ã‚Œã¾ã™ / Results will be displayed here</p>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Batch Execution Tab -->
    <div id="tab-batch" class="tab-content">
        <div class="section">
            <h2>ãƒãƒƒãƒå®Ÿè¡Œ / Batch Execution</h2>
            <div class="toolbar">
                <label>ãƒ—ãƒ­ã‚¸ã‚§ã‚¯ãƒˆ / Project:</label>
                <select id="batch-project-select">
                    <option value="">Loading...</option>
                </select>
                <button id="btn-batch-edit-prompt" class="btn btn-secondary">ãƒ—ãƒ­ãƒ³ãƒ—ãƒˆç·¨é›† / Edit Prompt</button>
                <button id="btn-batch-edit-parser" class="btn btn-secondary">ãƒ‘ãƒ¼ã‚µãƒ¼ç·¨é›† / Edit Parser</button>
                <label style="margin-left: 20px;">ãƒ‡ãƒ¼ã‚¿ã‚»ãƒƒãƒˆ / Dataset:</label>
                <select id="batch-dataset-select">
                    <option value="">ãƒ‡ãƒ¼ã‚¿ã‚»ãƒƒãƒˆã‚’é¸æŠ / Select Dataset</option>
                </select>
            </div>
            <div class="toolbar">
                <label>ãƒ¢ãƒ‡ãƒ« / Model:</label>
                <select id="batch-model-select">
                    <option value="azure-gpt-4.1">Azure GPT-4.1</option>
                    <option value="openai-gpt-4.1-nano">OpenAI GPT-4.1-nano</option>
                </select>
                <label style="margin-left: 1rem;">
                    <input type="checkbox" id="batch-include-csv-header" checked>
                    CSVãƒ˜ãƒƒãƒ€ã‚’ï¼‘è¡Œç›®ã®ã¿ã«å«ã‚ã‚‹ / Include CSV header in first row only
                </label>
                <button id="btn-batch-execute" class="btn btn-primary">ãƒãƒƒãƒå®Ÿè¡Œé–‹å§‹ / Start Batch</button>
                <button id="btn-stop-batch" class="btn btn-danger" style="display: none; margin-left: 1rem;">
                    â¹ åœæ­¢ / Stop
                </button>
            </div>
        </div>

        <div class="main-content">
            <div class="left-pane">
                <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 0.5rem;">
                    <h3 style="margin: 0;">ãƒãƒƒãƒã‚¸ãƒ§ãƒ–å±¥æ­´ / Batch Job History</h3>
                    <button id="btn-reload-batch-history" class="btn btn-secondary btn-sm" style="padding: 0.2rem 0.5rem; font-size: 0.75rem;">ğŸ”„</button>
                </div>
                <div id="batch-jobs-list" class="history-list">
                    <p class="loading">Loading...</p>
                </div>
            </div>

            <div class="right-pane">
                <div class="section">
                    <h3>ãƒãƒƒãƒå®Ÿè¡Œçµæœ / Batch Results</h3>
                    <div id="batch-execution-status" style="display: none;"></div>
                    <div id="batch-results-area">
                        <p class="info">ãƒãƒƒãƒã‚¸ãƒ§ãƒ–ã‚’é¸æŠã™ã‚‹ã¨çµæœãŒè¡¨ç¤ºã•ã‚Œã¾ã™ / Select a batch job to view results</p>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Projects Tab -->
    <div id="tab-projects" class="tab-content">
        <div class="section">
            <h2>ãƒ—ãƒ­ã‚¸ã‚§ã‚¯ãƒˆè¨­å®š / Project Management</h2>
            <button id="btn-create-project" class="btn btn-primary">æ–°è¦ãƒ—ãƒ­ã‚¸ã‚§ã‚¯ãƒˆä½œæˆ / Create Project</button>
        </div>

        <div class="section">
            <h3>ãƒ—ãƒ­ã‚¸ã‚§ã‚¯ãƒˆä¸€è¦§ / Projects</h3>
            <div id="projects-list">
                <p class="loading">Loading...</p>
            </div>
        </div>
    </div>

    <!-- System Settings Tab -->
    <div id="tab-settings" class="tab-content">
        <div class="settings-page">
            <!-- Page Header -->
            <div class="settings-header">
                <h2>ã‚·ã‚¹ãƒ†ãƒ è¨­å®š / System Settings</h2>
                <p class="settings-subtitle">ã‚¢ãƒ—ãƒªã‚±ãƒ¼ã‚·ãƒ§ãƒ³ã®å‹•ä½œã‚’ã‚«ã‚¹ã‚¿ãƒã‚¤ã‚ºã—ã¾ã™ / Customize application behavior</p>
            </div>

            <!-- Settings Grid Layout -->
            <div class="settings-grid">
                <!-- Default Settings Card -->
                <div class="settings-card">
                    <div class="settings-card-header">
                        <span class="settings-card-icon">âš™ï¸</span>
                        <h3>ãƒ‡ãƒ•ã‚©ãƒ«ãƒˆè¨­å®š / Defaults</h3>
                    </div>
                    <div class="settings-card-body">
                        <!-- Default Model -->
                        <div class="settings-row">
                            <div class="settings-row-label">
                                <span class="settings-label">ãƒ‡ãƒ•ã‚©ãƒ«ãƒˆLLMãƒ¢ãƒ‡ãƒ«</span>
                                <span class="settings-label-sub">Default LLM Model</span>
                            </div>
                            <div class="settings-row-control">
                                <select id="default-model-select" class="settings-select">
                                    <option value="">Loading...</option>
                                </select>
                                <button id="btn-save-default-model" class="btn btn-primary btn-sm">ä¿å­˜</button>
                            </div>
                        </div>
                        <p class="settings-hint">å˜ç™ºå®Ÿè¡Œãƒ»ãƒãƒƒãƒå®Ÿè¡Œã®ãƒ‡ãƒ•ã‚©ãƒ«ãƒˆãƒ¢ãƒ‡ãƒ«</p>

                        <div class="settings-divider"></div>

                        <!-- Default Project -->
                        <div class="settings-row">
                            <div class="settings-row-label">
                                <span class="settings-label">ãƒ‡ãƒ•ã‚©ãƒ«ãƒˆãƒ—ãƒ­ã‚¸ã‚§ã‚¯ãƒˆ</span>
                                <span class="settings-label-sub">Default Project</span>
                            </div>
                            <div class="settings-row-control">
                                <select id="default-project-select" class="settings-select">
                                    <option value="">Loading...</option>
                                </select>
                                <button id="btn-save-default-project" class="btn btn-primary btn-sm">ä¿å­˜</button>
                            </div>
                        </div>
                        <p class="settings-hint">å˜ç™ºå®Ÿè¡Œç”»é¢ã®ãƒ‡ãƒ•ã‚©ãƒ«ãƒˆãƒ—ãƒ­ã‚¸ã‚§ã‚¯ãƒˆ</p>
                    </div>
                </div>

                <!-- Job Execution Card -->
                <div class="settings-card">
                    <div class="settings-card-header">
                        <span class="settings-card-icon">ğŸš€</span>
                        <h3>ã‚¸ãƒ§ãƒ–å®Ÿè¡Œ / Execution</h3>
                    </div>
                    <div class="settings-card-body">
                        <div class="settings-row">
                            <div class="settings-row-label">
                                <span class="settings-label">ä¸¦åˆ—å®Ÿè¡Œæ•°</span>
                                <span class="settings-label-sub">Job Parallelism (1-99)</span>
                            </div>
                            <div class="settings-row-control">
                                <input type="number" id="job-parallelism" min="1" max="99" value="1" class="settings-input-number">
                                <button id="btn-save-parallelism" class="btn btn-primary btn-sm">ä¿å­˜</button>
                                <span id="parallelism-status" class="settings-status"></span>
                            </div>
                        </div>
                        <p class="settings-hint">åŒæ™‚ã«å®Ÿè¡Œã™ã‚‹ã‚¸ãƒ§ãƒ–ã‚¢ã‚¤ãƒ†ãƒ ã®æ•°ï¼ˆ1 = ç›´åˆ—å®Ÿè¡Œï¼‰</p>
                    </div>
                </div>

                <!-- File Processing Card -->
                <div class="settings-card">
                    <div class="settings-card-header">
                        <span class="settings-card-icon">ğŸ“„</span>
                        <h3>ãƒ•ã‚¡ã‚¤ãƒ«å‡¦ç† / File Processing</h3>
                    </div>
                    <div class="settings-card-body">
                        <div class="settings-row">
                            <div class="settings-row-label">
                                <span class="settings-label">ãƒ†ã‚­ã‚¹ãƒˆæ‹¡å¼µå­</span>
                                <span class="settings-label-sub">Text File Extensions</span>
                            </div>
                            <div class="settings-row-control" style="flex-direction: column; align-items: flex-start; gap: 0.5rem;">
                                <div style="display: flex; gap: 0.5rem; width: 100%;">
                                    <input type="text" id="text-file-extensions" class="settings-input-text" style="flex: 1;" placeholder="txt,csv,md,json...">
                                    <button id="btn-save-text-extensions" class="btn btn-primary btn-sm">ä¿å­˜</button>
                                    <button id="btn-reset-text-extensions" class="btn btn-secondary btn-sm">ãƒªã‚»ãƒƒãƒˆ</button>
                                </div>
                                <span id="text-extensions-status" class="settings-status"></span>
                            </div>
                        </div>
                        <p class="settings-hint">FILEPATHãƒ‘ãƒ©ãƒ¡ãƒ¼ã‚¿ã§ãƒ†ã‚­ã‚¹ãƒˆã¨ã—ã¦å±•é–‹ã™ã‚‹æ‹¡å¼µå­ï¼ˆã‚«ãƒ³ãƒåŒºåˆ‡ã‚Šï¼‰<br>ç©ºæ¬„ã«ã™ã‚‹ã¨å…¨ã¦ã®ãƒ•ã‚¡ã‚¤ãƒ«ãŒç”»åƒã¨ã—ã¦LLMã«é€ä¿¡ã•ã‚Œã¾ã™</p>
                    </div>
                </div>

                <!-- Model Parameters Card -->
                <div class="settings-card settings-card-wide">
                    <div class="settings-card-header">
                        <span class="settings-card-icon">ğŸ›ï¸</span>
                        <h3>ãƒ¢ãƒ‡ãƒ«ãƒ‘ãƒ©ãƒ¡ãƒ¼ã‚¿ / Model Parameters</h3>
                    </div>
                    <div class="settings-card-body">
                        <div class="settings-row">
                            <div class="settings-row-label">
                                <span class="settings-label">ãƒ¢ãƒ‡ãƒ«é¸æŠ</span>
                                <span class="settings-label-sub">Select Model</span>
                            </div>
                            <div class="settings-row-control">
                                <select id="param-model-select" class="settings-select">
                                    <option value="">Loading...</option>
                                </select>
                            </div>
                        </div>

                        <div id="model-parameters-form" class="model-params-form" style="display: none;">
                            <div class="params-grid">
                                <div class="param-item" id="param-temperature-group">
                                    <label class="param-label">Temperature</label>
                                    <div class="param-input-row">
                                        <input type="number" id="param-temperature" min="0" max="2" step="0.1" value="0.7" class="settings-input-number">
                                        <span id="default-temperature" class="param-default"></span>
                                    </div>
                                    <span class="param-range">0 - 2</span>
                                </div>
                                <div class="param-item" id="param-max-tokens-group">
                                    <label class="param-label">Max Tokens</label>
                                    <div class="param-input-row">
                                        <input type="number" id="param-max-tokens" min="100" max="32000" step="100" value="4000" class="settings-input-number">
                                        <span id="default-max-tokens" class="param-default"></span>
                                    </div>
                                    <span class="param-range">100 - 32000</span>
                                </div>
                                <div class="param-item" id="param-top-p-group">
                                    <label class="param-label">Top P</label>
                                    <div class="param-input-row">
                                        <input type="number" id="param-top-p" min="0" max="1" step="0.1" value="1.0" class="settings-input-number">
                                        <span id="default-top-p" class="param-default"></span>
                                    </div>
                                    <span class="param-range">0 - 1</span>
                                </div>
                                <div class="param-item" id="param-max-output-tokens-group" style="display: none;">
                                    <label class="param-label">Max Output Tokens <span class="param-badge">GPT-5</span></label>
                                    <div class="param-input-row">
                                        <input type="number" id="param-max-output-tokens" min="1024" max="65536" step="1024" value="8192" class="settings-input-number">
                                        <span id="default-max-output-tokens" class="param-default"></span>
                                    </div>
                                    <span class="param-range">æ¨å¥¨: 8192 - 16384</span>
                                </div>
                                <div class="param-item" id="param-verbosity-group" style="display: none;">
                                    <label class="param-label">Verbosity <span class="param-badge">GPT-5</span></label>
                                    <div class="param-input-row">
                                        <select id="param-verbosity" class="settings-select-sm">
                                            <option value="low">Low</option>
                                            <option value="medium">Medium</option>
                                            <option value="high">High</option>
                                        </select>
                                        <span id="default-verbosity" class="param-default"></span>
                                    </div>
                                </div>
                                <div class="param-item" id="param-reasoning-effort-group" style="display: none;">
                                    <label class="param-label">Reasoning Effort <span class="param-badge">GPT-5</span></label>
                                    <div class="param-input-row">
                                        <select id="param-reasoning-effort" class="settings-select-sm">
                                            <option value="minimal">Minimal</option>
                                            <option value="low">Low</option>
                                            <option value="medium">Medium</option>
                                            <option value="high">High</option>
                                        </select>
                                        <span id="default-reasoning-effort" class="param-default"></span>
                                    </div>
                                </div>
                            </div>
                            <div class="params-actions">
                                <button id="btn-save-model-params" class="btn btn-primary">ãƒ‘ãƒ©ãƒ¡ãƒ¼ã‚¿ä¿å­˜ / Save</button>
                                <button id="btn-reset-model-params" class="btn btn-secondary">ãƒ‡ãƒ•ã‚©ãƒ«ãƒˆã«æˆ»ã™ / Reset</button>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Available Models Card -->
                <div class="settings-card">
                    <div class="settings-card-header">
                        <span class="settings-card-icon">ğŸ¤–</span>
                        <h3>åˆ©ç”¨å¯èƒ½ãªãƒ¢ãƒ‡ãƒ« / Available Models</h3>
                    </div>
                    <div class="settings-card-body">
                        <div id="available-models" class="models-list">
                            <p class="loading">Loading...</p>
                        </div>
                    </div>
                </div>

                <!-- Model Configuration Card -->
                <div class="settings-card">
                    <div class="settings-card-header">
                        <span class="settings-card-icon">ğŸ”§</span>
                        <h3>ãƒ¢ãƒ‡ãƒ«è¨­å®š / Model Configuration</h3>
                    </div>
                    <div class="settings-card-body">
                        <p class="settings-hint" style="margin-bottom: 1rem;">å„ãƒ¢ãƒ‡ãƒ«ã®æœ‰åŠ¹/ç„¡åŠ¹ã¨ãƒ‘ãƒ©ãƒ¡ãƒ¼ã‚¿ã‚’è¨­å®š</p>
                        <div id="model-configuration-settings" class="model-config-list">
                            <p class="loading">Loading...</p>
                        </div>
                    </div>
                </div>

                <!-- API Configuration Card -->
                <div class="settings-card">
                    <div class="settings-card-header">
                        <span class="settings-card-icon">ğŸ”‘</span>
                        <h3>APIè¨­å®š / API Configuration</h3>
                    </div>
                    <div class="settings-card-body">
                        <div class="api-info-box">
                            <p class="api-info-text">APIè¨­å®šã¯ <code>.env</code> ãƒ•ã‚¡ã‚¤ãƒ«ã§ç®¡ç†ã•ã‚Œã¾ã™</p>
                        </div>
                        <div class="api-keys-list">
                            <div class="api-key-item">
                                <span class="api-key-name">AZURE_OPENAI_ENDPOINT</span>
                                <span class="api-key-badge required">Required</span>
                            </div>
                            <div class="api-key-item">
                                <span class="api-key-name">AZURE_OPENAI_API_KEY</span>
                                <span class="api-key-badge required">Required</span>
                            </div>
                            <div class="api-key-item">
                                <span class="api-key-name">OPENAI_API_KEY</span>
                                <span class="api-key-badge optional">Optional</span>
                            </div>
                            <div class="api-key-item">
                                <span class="api-key-name">AZURE_OPENAI_GPT5_MINI_DEPLOYMENT_NAME</span>
                                <span class="api-key-badge optional">Optional</span>
                            </div>
                            <div class="api-key-item">
                                <span class="api-key-name">AZURE_OPENAI_GPT5_NANO_DEPLOYMENT_NAME</span>
                                <span class="api-key-badge optional">Optional</span>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Database Card -->
                <div class="settings-card settings-card-compact">
                    <div class="settings-card-header">
                        <span class="settings-card-icon">ğŸ’¾</span>
                        <h3>ãƒ‡ãƒ¼ã‚¿ãƒ™ãƒ¼ã‚¹ / Database</h3>
                    </div>
                    <div class="settings-card-body">
                        <div class="settings-row">
                            <div class="settings-row-label">
                                <span class="settings-label">ãƒ‡ãƒ¼ã‚¿ãƒ™ãƒ¼ã‚¹ãƒ‘ã‚¹</span>
                                <span class="settings-label-sub">Database Path</span>
                            </div>
                            <div class="settings-row-control">
                                <code id="db-path" class="db-path-display">database/app.db</code>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Datasets Tab -->
    <div id="tab-datasets" class="tab-content">
        <div class="section">
            <h2>ãƒ‡ãƒ¼ã‚¿ã‚»ãƒƒãƒˆç®¡ç† / Dataset Management</h2>
            <button id="btn-import-dataset" class="btn btn-primary">ãƒ‡ãƒ¼ã‚¿ã‚»ãƒƒãƒˆã‚¤ãƒ³ãƒãƒ¼ãƒˆ / Import Dataset</button>
        </div>

        <div class="section">
            <h3>ãƒ‡ãƒ¼ã‚¿ã‚»ãƒƒãƒˆä¸€è¦§ / Datasets</h3>
            <div id="datasets-list">
                <p class="loading">Loading...</p>
            </div>
        </div>
    </div>
</div>

<!-- Modals -->
<div id="modal-overlay" class="modal-overlay">
    <div id="modal-content" class="modal-content">
        <!-- Dynamic modal content -->
    </div>
</div>

<!-- Secondary Modal for Help -->
<div id="modal-overlay-2" class="modal-overlay">
    <div id="modal-content-2" class="modal-content">
        <!-- Dynamic help modal content -->
    </div>
</div>

{% endblock %}

{% block scripts %}
<script src="/static/js/app.js?v=20251207_130930"></script>
{% endblock %}
