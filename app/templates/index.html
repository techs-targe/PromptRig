{% extends "base.html" %}

{% block title %}プロンプト評価システム - Prompt Evaluation System{% endblock %}

{% block content %}
<div class="container">
    <!-- Tab Navigation -->
    <div class="tab-navigation">
        <button class="tab-button active" data-tab="single">単発実行 / Single Execution</button>
        <button class="tab-button" data-tab="batch">バッチ実行 / Batch Execution</button>
        <button class="tab-button" data-tab="workflows">ワークフロー / Workflows</button>
        <button class="tab-button" data-tab="projects">プロジェクト設定 / Projects</button>
        <button class="tab-button" data-tab="settings">システム設定 / System Settings</button>
        <button class="tab-button" data-tab="datasets">データセット / Datasets</button>
    </div>

    <!-- Tab Content Areas -->

    <!-- Single Execution Tab -->
    <div id="tab-single" class="tab-content active">
        <!-- Control Panel -->
        <div class="exec-control-panel">
            <div class="exec-control-row">
                <div class="exec-control-group">
                    <label class="exec-control-label">
                        <span class="exec-control-icon">📁</span>
                        プロジェクト / Project
                    </label>
                    <select id="single-project-select" class="exec-select">
                        <option value="">Loading...</option>
                    </select>
                </div>
                <div class="exec-control-group">
                    <label class="exec-control-label">
                        <span class="exec-control-icon">🎯</span>
                        実行対象 / Target
                    </label>
                    <select id="single-target-select" class="exec-select" style="min-width: 200px;">
                        <option value="">Loading...</option>
                    </select>
                </div>
                <div class="exec-control-group">
                    <label class="exec-control-label">
                        <span class="exec-control-icon">🤖</span>
                        モデル / Model
                    </label>
                    <select id="model-select" class="exec-select">
                        <option value="azure-gpt-4.1">Azure GPT-4.1</option>
                        <option value="openai-gpt-4.1-nano">OpenAI GPT-4.1-nano</option>
                    </select>
                </div>
                <div class="exec-control-group exec-control-actions">
                    <button id="btn-edit-prompt" class="btn btn-outline">
                        <span>✏️</span> プロンプト編集
                    </button>
                </div>
            </div>
        </div>

        <div class="main-content">
            <!-- History Sidebar -->
            <div class="left-pane exec-sidebar">
                <div class="exec-sidebar-header">
                    <h3><span class="exec-control-icon">📜</span> 実行履歴 / History</h3>
                    <button id="btn-reload-single-history" class="btn btn-icon" title="更新">🔄</button>
                </div>
                <div id="history-list" class="history-list">
                    <p class="loading">Loading...</p>
                </div>
            </div>

            <!-- Main Content Area -->
            <div class="right-pane">
                <!-- Prompt Template Card -->
                <div class="exec-card">
                    <div class="exec-card-header">
                        <h3><span class="exec-control-icon">📝</span> プロンプトテンプレート / Prompt Template</h3>
                    </div>
                    <div class="exec-card-body">
                        <div class="prompt-template-box">
                            <pre id="prompt-template">Loading...</pre>
                        </div>
                    </div>
                </div>

                <!-- Input Parameters Card -->
                <div class="exec-card">
                    <div class="exec-card-header">
                        <h3><span class="exec-control-icon">⚡</span> 入力パラメータ / Input Parameters</h3>
                        <button type="button" id="btn-select-from-dataset" class="btn btn-outline btn-sm" onclick="showDatasetSelectorForSingle()">
                            📋 データセットから選択
                        </button>
                    </div>
                    <div class="exec-card-body">
                        <form id="input-form">
                            <div id="parameter-inputs">
                                <p class="loading">Loading...</p>
                            </div>

                            <div id="execution-status" class="status-message"></div>

                            <div class="exec-action-bar">
                                <div class="exec-action-primary">
                                    <button type="button" id="btn-send-once" class="btn btn-primary btn-lg">
                                        ▶️ 1件送信 / Send Once
                                    </button>
                                    <button type="button" id="btn-stop-single" class="btn btn-danger btn-lg" style="display: none;">
                                        ⏹ 停止 / Stop
                                    </button>
                                </div>
                                <div class="exec-action-secondary">
                                    <div class="exec-repeat-control">
                                        <label for="repeat-count">回数:</label>
                                        <input type="number" id="repeat-count" min="1" max="10" value="3" class="exec-input-number">
                                        <button type="button" id="btn-send-repeat" class="btn btn-secondary">
                                            🔁 n回送信
                                        </button>
                                    </div>
                                    <label class="exec-checkbox">
                                        <input type="checkbox" id="single-include-csv-header" checked>
                                        <span>CSVヘッダを１行目のみに含める</span>
                                    </label>
                                </div>
                            </div>
                        </form>
                    </div>
                </div>

                <!-- Results Card -->
                <div class="exec-card">
                    <div class="exec-card-header">
                        <h3><span class="exec-control-icon">📊</span> 実行結果 / Results</h3>
                    </div>
                    <div class="exec-card-body">
                        <div id="results-area">
                            <p class="info">実行結果がここに表示されます / Results will be displayed here</p>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Batch Execution Tab -->
    <div id="tab-batch" class="tab-content">
        <!-- Control Panel -->
        <div class="exec-control-panel">
            <div class="exec-control-row">
                <div class="exec-control-group">
                    <label class="exec-control-label">
                        <span class="exec-control-icon">📁</span>
                        プロジェクト / Project
                    </label>
                    <select id="batch-project-select" class="exec-select">
                        <option value="">Loading...</option>
                    </select>
                </div>
                <div class="exec-control-group">
                    <label class="exec-control-label">
                        <span class="exec-control-icon">🎯</span>
                        プロンプト / Prompt
                    </label>
                    <select id="batch-prompt-select" class="exec-select" style="min-width: 200px;">
                        <option value="">プロンプトを選択 / Select Prompt</option>
                    </select>
                </div>
                <div class="exec-control-group">
                    <label class="exec-control-label">
                        <span class="exec-control-icon">📋</span>
                        データセット / Dataset
                    </label>
                    <select id="batch-dataset-select" class="exec-select" style="min-width: 200px;">
                        <option value="">データセットを選択 / Select Dataset</option>
                    </select>
                </div>
                <div class="exec-control-group">
                    <label class="exec-control-label">
                        <span class="exec-control-icon">🤖</span>
                        モデル / Model
                    </label>
                    <select id="batch-model-select" class="exec-select">
                        <option value="azure-gpt-4.1">Azure GPT-4.1</option>
                        <option value="openai-gpt-4.1-nano">OpenAI GPT-4.1-nano</option>
                    </select>
                </div>
                <div class="exec-control-group exec-control-actions">
                    <button id="btn-batch-edit-prompt" class="btn btn-outline">
                        <span>✏️</span> プロンプト編集
                    </button>
                </div>
            </div>
            <div class="exec-control-row exec-control-row-actions">
                <label class="exec-checkbox">
                    <input type="checkbox" id="batch-include-csv-header" checked>
                    <span>CSVヘッダを１行目のみに含める</span>
                </label>
                <div class="exec-batch-buttons">
                    <button id="btn-batch-execute" class="btn btn-primary btn-lg">
                        🚀 バッチ実行開始 / Start Batch
                    </button>
                    <button id="btn-stop-batch" class="btn btn-danger btn-lg" style="display: none;">
                        ⏹ 停止 / Stop
                    </button>
                </div>
            </div>
        </div>

        <div class="main-content">
            <!-- History Sidebar -->
            <div class="left-pane exec-sidebar">
                <div class="exec-sidebar-header">
                    <h3><span class="exec-control-icon">📜</span> バッチジョブ履歴</h3>
                    <button id="btn-reload-batch-history" class="btn btn-icon" title="更新">🔄</button>
                </div>
                <div id="batch-jobs-list" class="history-list">
                    <p class="loading">Loading...</p>
                </div>
            </div>

            <!-- Main Content Area -->
            <div class="right-pane">
                <!-- Results Card -->
                <div class="exec-card">
                    <div class="exec-card-header">
                        <h3><span class="exec-control-icon">📊</span> バッチ実行結果 / Batch Results</h3>
                    </div>
                    <div class="exec-card-body">
                        <div id="batch-execution-status" style="display: none;"></div>
                        <div id="batch-results-area">
                            <p class="info">バッチジョブを選択すると結果が表示されます / Select a batch job to view results</p>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Workflows Tab -->
    <div id="tab-workflows" class="tab-content">
        <!-- Workflow Header Section -->
        <div class="workflow-header-section">
            <div class="workflow-header-top">
                <div class="workflow-header-title">
                    <h2>ワークフロー / Workflows</h2>
                    <p class="workflow-header-desc">複数のプロンプトを連結して実行</p>
                </div>
                <div class="workflow-header-actions">
                    <button id="btn-create-workflow" class="btn btn-primary btn-create-workflow" onclick="showCreateWorkflowForm()" disabled>
                        <span class="btn-icon">+</span> 新規作成
                    </button>
                    <button id="btn-import-workflow" class="btn btn-secondary" onclick="showImportWorkflowDialog()">
                        <span class="btn-icon">📥</span> JSONインポート
                    </button>
                </div>
            </div>
            <div class="workflow-project-selector">
                <label class="workflow-project-label">
                    <span class="label-icon">📁</span>
                    プロジェクト
                </label>
                <select id="workflow-project-select" class="workflow-project-dropdown" onchange="onWorkflowProjectChange()">
                    <option value="">-- 選択してください --</option>
                </select>
                <span id="workflow-project-hint" class="workflow-project-hint">
                    ※ プロジェクトを選択すると作成可能になります
                </span>
            </div>
        </div>

        <div class="main-content">
            <div class="left-pane">
                <h3 class="workflow-list-title">一覧</h3>
                <div id="workflow-list" class="history-list">
                    <!-- Workflow list will be rendered here -->
                </div>
            </div>

            <div class="right-pane">
                <!-- Workflow Editor (hidden by default) -->
                <div id="workflow-editor" class="workflow-editor-panel" style="display: none;">
                    <div class="workflow-editor-header">
                        <h3 id="workflow-editor-title">ワークフロー作成</h3>
                        <span id="workflow-editor-id-info" style="color: #aaa; font-size: 0.75rem; margin-left: 0.5rem;"></span>
                        <button class="btn-close-editor" onclick="hideWorkflowEditor()" title="閉じる">×</button>
                    </div>
                    <form id="workflow-form" class="workflow-editor-form" onsubmit="event.preventDefault(); saveWorkflow();">
                        <div class="workflow-basic-info">
                            <div class="form-group">
                                <label>名前</label>
                                <input type="text" id="workflow-name" required placeholder="ワークフロー名を入力">
                            </div>
                            <div class="form-group">
                                <label>説明 <span class="optional-label">(任意)</span></label>
                                <textarea id="workflow-description" rows="2" placeholder="このワークフローの説明"></textarea>
                            </div>
                            <div class="form-group" style="margin-top: 0.75rem;">
                                <label class="checkbox-label" style="display: flex; align-items: center; gap: 0.5rem; cursor: pointer;">
                                    <input type="checkbox" id="workflow-auto-context" style="width: 18px; height: 18px;">
                                    <span>自動CONTEXT / Auto-Context</span>
                                    <span class="optional-label" style="font-weight: normal;">(前ステップのUSER/ASSISTANTをCONTEXTに自動追加)</span>
                                </label>
                            </div>
                        </div>

                        <div class="workflow-steps-section">
                            <div class="steps-section-header">
                                <h4>ステップ構成</h4>
                                <span class="steps-hint">前のステップの出力: <code>{% raw %}{{step1.field}}{% endraw %}</code></span>
                            </div>
                            <div id="workflow-steps-container">
                                <!-- Dynamic step forms will be added here -->
                            </div>
                            <button type="button" class="btn-add-step" onclick="addWorkflowStep()">
                                <span class="btn-icon">+</span> ステップ追加
                            </button>
                        </div>

                        <div class="workflow-form-actions">
                            <input type="hidden" id="workflow-id" value="">
                            <button type="submit" class="btn btn-primary">保存</button>
                            <button type="button" class="btn btn-secondary" onclick="saveWorkflowAs()" id="btn-workflow-save-as" style="display: none;">別名で保存</button>
                            <button type="button" class="btn btn-secondary" onclick="exportWorkflow()" id="btn-workflow-export" style="display: none;">JSONエクスポート</button>
                            <button type="button" class="btn btn-secondary" onclick="hideWorkflowEditor()">キャンセル</button>
                            <button type="button" class="btn btn-danger" onclick="deleteWorkflow()" id="btn-workflow-delete" style="display: none;">削除</button>
                        </div>
                    </form>
                </div>

            </div>
        </div>
    </div>

    <!-- Projects Tab -->
    <div id="tab-projects" class="tab-content">
        <div class="section">
            <h2>プロジェクト設定 / Project Management</h2>
            <button id="btn-create-project" class="btn btn-primary">新規プロジェクト作成 / Create Project</button>
        </div>

        <div class="section">
            <h3>プロジェクト一覧 / Projects</h3>
            <div id="projects-list">
                <p class="loading">Loading...</p>
            </div>
        </div>
    </div>

    <!-- System Settings Tab -->
    <div id="tab-settings" class="tab-content">
        <div class="settings-page">
            <!-- Page Header -->
            <div class="settings-header">
                <h2>システム設定 / System Settings</h2>
                <p class="settings-subtitle">アプリケーションの動作をカスタマイズします / Customize application behavior</p>
            </div>

            <!-- Settings Grid Layout -->
            <div class="settings-grid">
                <!-- Default Settings Card -->
                <div class="settings-card">
                    <div class="settings-card-header">
                        <span class="settings-card-icon">⚙️</span>
                        <h3>デフォルト設定 / Defaults</h3>
                    </div>
                    <div class="settings-card-body">
                        <!-- Default Model -->
                        <div class="settings-row">
                            <div class="settings-row-label">
                                <span class="settings-label">デフォルトLLMモデル</span>
                                <span class="settings-label-sub">Default LLM Model</span>
                            </div>
                            <div class="settings-row-control">
                                <select id="default-model-select" class="settings-select">
                                    <option value="">Loading...</option>
                                </select>
                                <button id="btn-save-default-model" class="btn btn-primary btn-sm">保存</button>
                            </div>
                        </div>
                        <p class="settings-hint">単発実行・バッチ実行のデフォルトモデル</p>

                        <div class="settings-divider"></div>

                        <!-- Default Project -->
                        <div class="settings-row">
                            <div class="settings-row-label">
                                <span class="settings-label">デフォルトプロジェクト</span>
                                <span class="settings-label-sub">Default Project</span>
                            </div>
                            <div class="settings-row-control">
                                <select id="default-project-select" class="settings-select">
                                    <option value="">Loading...</option>
                                </select>
                                <button id="btn-save-default-project" class="btn btn-primary btn-sm">保存</button>
                            </div>
                        </div>
                        <p class="settings-hint">単発実行画面のデフォルトプロジェクト</p>
                    </div>
                </div>

                <!-- Job Execution Card -->
                <div class="settings-card">
                    <div class="settings-card-header">
                        <span class="settings-card-icon">🚀</span>
                        <h3>ジョブ実行 / Execution</h3>
                    </div>
                    <div class="settings-card-body">
                        <div class="settings-row">
                            <div class="settings-row-label">
                                <span class="settings-label">並列実行数</span>
                                <span class="settings-label-sub">Job Parallelism (1-99)</span>
                            </div>
                            <div class="settings-row-control">
                                <input type="number" id="job-parallelism" min="1" max="99" value="1" class="settings-input-number">
                                <button id="btn-save-parallelism" class="btn btn-primary btn-sm">保存</button>
                                <span id="parallelism-status" class="settings-status"></span>
                            </div>
                        </div>
                        <p class="settings-hint">同時に実行するジョブアイテムの数（1 = 直列実行）</p>
                    </div>
                </div>

                <!-- File Processing Card -->
                <div class="settings-card">
                    <div class="settings-card-header">
                        <span class="settings-card-icon">📄</span>
                        <h3>ファイル処理 / File Processing</h3>
                    </div>
                    <div class="settings-card-body">
                        <div class="settings-row">
                            <div class="settings-row-label">
                                <span class="settings-label">テキスト拡張子</span>
                                <span class="settings-label-sub">Text File Extensions</span>
                            </div>
                            <div class="settings-row-control" style="flex-direction: column; align-items: flex-start; gap: 0.5rem;">
                                <div style="display: flex; gap: 0.5rem; width: 100%;">
                                    <input type="text" id="text-file-extensions" class="settings-input-text" style="flex: 1;" placeholder="txt,csv,md,json...">
                                    <button id="btn-save-text-extensions" class="btn btn-primary btn-sm">保存</button>
                                    <button id="btn-reset-text-extensions" class="btn btn-secondary btn-sm">リセット</button>
                                </div>
                                <span id="text-extensions-status" class="settings-status"></span>
                            </div>
                        </div>
                        <p class="settings-hint">FILEPATHパラメータでテキストとして展開する拡張子（カンマ区切り）<br>空欄にすると全てのファイルが画像としてLLMに送信されます</p>
                    </div>
                </div>

                <!-- Model Parameters Card -->
                <div class="settings-card settings-card-wide">
                    <div class="settings-card-header">
                        <span class="settings-card-icon">🎛️</span>
                        <h3>モデルパラメータ / Model Parameters</h3>
                    </div>
                    <div class="settings-card-body">
                        <div class="settings-row">
                            <div class="settings-row-label">
                                <span class="settings-label">モデル選択</span>
                                <span class="settings-label-sub">Select Model</span>
                            </div>
                            <div class="settings-row-control">
                                <select id="param-model-select" class="settings-select">
                                    <option value="">Loading...</option>
                                </select>
                            </div>
                        </div>

                        <div id="model-parameters-form" class="model-params-form" style="display: none;">
                            <div class="params-grid">
                                <div class="param-item" id="param-temperature-group">
                                    <label class="param-label">Temperature</label>
                                    <div class="param-input-row">
                                        <input type="number" id="param-temperature" min="0" max="2" step="0.1" value="0.7" class="settings-input-number">
                                        <span id="default-temperature" class="param-default"></span>
                                    </div>
                                    <span class="param-range">0 - 2</span>
                                </div>
                                <div class="param-item" id="param-max-tokens-group">
                                    <label class="param-label">Max Tokens</label>
                                    <div class="param-input-row">
                                        <input type="number" id="param-max-tokens" min="100" max="32000" step="100" value="4000" class="settings-input-number">
                                        <span id="default-max-tokens" class="param-default"></span>
                                    </div>
                                    <span class="param-range">100 - 32000</span>
                                </div>
                                <div class="param-item" id="param-top-p-group">
                                    <label class="param-label">Top P</label>
                                    <div class="param-input-row">
                                        <input type="number" id="param-top-p" min="0" max="1" step="0.1" value="1.0" class="settings-input-number">
                                        <span id="default-top-p" class="param-default"></span>
                                    </div>
                                    <span class="param-range">0 - 1</span>
                                </div>
                                <div class="param-item" id="param-max-output-tokens-group" style="display: none;">
                                    <label class="param-label">Max Output Tokens <span class="param-badge">GPT-5</span></label>
                                    <div class="param-input-row">
                                        <input type="number" id="param-max-output-tokens" min="1024" max="65536" step="1024" value="8192" class="settings-input-number">
                                        <span id="default-max-output-tokens" class="param-default"></span>
                                    </div>
                                    <span class="param-range">推奨: 8192 - 16384</span>
                                </div>
                                <div class="param-item" id="param-verbosity-group" style="display: none;">
                                    <label class="param-label">Verbosity <span class="param-badge">GPT-5</span></label>
                                    <div class="param-input-row">
                                        <select id="param-verbosity" class="settings-select-sm">
                                            <option value="low">Low</option>
                                            <option value="medium">Medium</option>
                                            <option value="high">High</option>
                                        </select>
                                        <span id="default-verbosity" class="param-default"></span>
                                    </div>
                                </div>
                                <div class="param-item" id="param-reasoning-effort-group" style="display: none;">
                                    <label class="param-label">Reasoning Effort <span class="param-badge">GPT-5</span></label>
                                    <div class="param-input-row">
                                        <select id="param-reasoning-effort" class="settings-select-sm">
                                            <option value="minimal">Minimal</option>
                                            <option value="low">Low</option>
                                            <option value="medium">Medium</option>
                                            <option value="high">High</option>
                                        </select>
                                        <span id="default-reasoning-effort" class="param-default"></span>
                                    </div>
                                </div>
                            </div>
                            <div class="params-actions">
                                <button id="btn-save-model-params" class="btn btn-primary">パラメータ保存 / Save</button>
                                <button id="btn-reset-model-params" class="btn btn-secondary">デフォルトに戻す / Reset</button>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Available Models Card -->
                <div class="settings-card">
                    <div class="settings-card-header">
                        <span class="settings-card-icon">🤖</span>
                        <h3>利用可能なモデル / Available Models</h3>
                    </div>
                    <div class="settings-card-body">
                        <div id="available-models" class="models-list">
                            <p class="loading">Loading...</p>
                        </div>
                    </div>
                </div>

                <!-- Model Configuration Card -->
                <div class="settings-card">
                    <div class="settings-card-header">
                        <span class="settings-card-icon">🔧</span>
                        <h3>モデル設定 / Model Configuration</h3>
                    </div>
                    <div class="settings-card-body">
                        <p class="settings-hint" style="margin-bottom: 1rem;">各モデルの有効/無効とパラメータを設定</p>
                        <div id="model-configuration-settings" class="model-config-list">
                            <p class="loading">Loading...</p>
                        </div>
                    </div>
                </div>

                <!-- API Configuration Card -->
                <div class="settings-card">
                    <div class="settings-card-header">
                        <span class="settings-card-icon">🔑</span>
                        <h3>API設定 / API Configuration</h3>
                    </div>
                    <div class="settings-card-body">
                        <div class="api-info-box">
                            <p class="api-info-text">API設定は <code>.env</code> ファイルで管理されます</p>
                        </div>
                        <div class="api-keys-list">
                            <div class="api-key-item">
                                <span class="api-key-name">AZURE_OPENAI_ENDPOINT</span>
                                <span class="api-key-badge required">Required</span>
                            </div>
                            <div class="api-key-item">
                                <span class="api-key-name">AZURE_OPENAI_API_KEY</span>
                                <span class="api-key-badge required">Required</span>
                            </div>
                            <div class="api-key-item">
                                <span class="api-key-name">OPENAI_API_KEY</span>
                                <span class="api-key-badge optional">Optional</span>
                            </div>
                            <div class="api-key-item">
                                <span class="api-key-name">AZURE_OPENAI_GPT5_MINI_DEPLOYMENT_NAME</span>
                                <span class="api-key-badge optional">Optional</span>
                            </div>
                            <div class="api-key-item">
                                <span class="api-key-name">AZURE_OPENAI_GPT5_NANO_DEPLOYMENT_NAME</span>
                                <span class="api-key-badge optional">Optional</span>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Tag Management Card -->
                <div class="settings-card settings-card-wide">
                    <div class="settings-card-header">
                        <span class="settings-card-icon">🏷️</span>
                        <h3>タグ管理 / Tag Management</h3>
                    </div>
                    <div class="settings-card-body">
                        <p class="settings-hint" style="margin-bottom: 1rem;">
                            プロンプトにタグを付けてアクセス制御を行います。モデルごとに許可タグを設定できます。
                        </p>

                        <!-- Tag List -->
                        <div class="tag-management-section">
                            <div class="tag-section-header">
                                <h4>登録タグ一覧</h4>
                                <button class="btn btn-primary btn-sm" onclick="showCreateTagModal()">
                                    + 新規タグ作成
                                </button>
                            </div>
                            <div id="tags-list" class="tags-list">
                                <p class="loading">Loading...</p>
                            </div>
                        </div>

                        <div class="settings-divider"></div>

                        <!-- Model Tag Configuration -->
                        <div class="tag-management-section">
                            <div class="tag-section-header">
                                <h4>モデル別許可タグ設定</h4>
                            </div>
                            <p class="settings-hint" style="margin-bottom: 0.75rem;">
                                各モデルで実行可能なプロンプトのタグを設定します。設定されていないモデルはALLタグのみ許可されます。
                            </p>
                            <div id="model-tags-config" class="model-tags-config">
                                <p class="loading">Loading...</p>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Database Card -->
                <div class="settings-card settings-card-compact">
                    <div class="settings-card-header">
                        <span class="settings-card-icon">💾</span>
                        <h3>データベース / Database</h3>
                    </div>
                    <div class="settings-card-body">
                        <div class="settings-row">
                            <div class="settings-row-label">
                                <span class="settings-label">データベースパス</span>
                                <span class="settings-label-sub">Database Path</span>
                            </div>
                            <div class="settings-row-control">
                                <code id="db-path" class="db-path-display">database/app.db</code>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Datasets Tab -->
    <div id="tab-datasets" class="tab-content">
        <div class="section">
            <h2>データセット管理 / Dataset Management</h2>
            <button id="btn-import-dataset" class="btn btn-primary">データセットインポート / Import Dataset</button>
        </div>

        <div class="section">
            <h3>データセット一覧 / Datasets</h3>
            <div id="datasets-list">
                <p class="loading">Loading...</p>
            </div>
        </div>
    </div>
</div>

<!-- Modals -->
<div id="modal-overlay" class="modal-overlay">
    <div id="modal-content" class="modal-content">
        <!-- Dynamic modal content -->
    </div>
</div>

<!-- Secondary Modal for Help -->
<div id="modal-overlay-2" class="modal-overlay">
    <div id="modal-content-2" class="modal-content">
        <!-- Dynamic help modal content -->
    </div>
</div>

<!-- Variable Picker Modal -->
<div id="variable-picker-overlay" class="modal-overlay" style="z-index: 1100;">
    <div id="variable-picker-modal" class="modal-content" style="max-width: 650px; max-height: 85vh; display: flex; flex-direction: column;">
        <div class="modal-header" style="display: flex; justify-content: space-between; align-items: center; padding-bottom: 1rem; border-bottom: 1px solid #ddd;">
            <h3 style="margin: 0;">🔧 変数・数式を挿入 / Insert Variable or Formula</h3>
            <button class="btn btn-secondary" onclick="closeVariablePicker()">✕</button>
        </div>

        <!-- Composition Area (shared across tabs) -->
        <div class="vp-composition-area">
            <label class="vp-composition-label">📝 作成エリア / Composition Area:</label>
            <textarea id="vp-composition-input" class="vp-composition-input" rows="2"
                      placeholder="変数をクリックするとここに追加されます / Click variables to add them here"></textarea>
        </div>

        <!-- Tabs -->
        <div class="vp-tabs">
            <button type="button" class="vp-tab active" data-tab="variables" onclick="switchVariablePickerTab('variables')">
                📥 変数 / Variables
            </button>
            <button type="button" class="vp-tab" data-tab="formula" onclick="switchVariablePickerTab('formula')">
                🧮 数式ヘルプ / Formula Help
            </button>
        </div>

        <!-- Variables Tab Content -->
        <div id="vp-tab-variables" class="vp-tab-content active">
            <div style="padding: 0.5rem 0;">
                <input type="text" id="variable-search" placeholder="🔍 変数を検索... / Search variables..."
                       style="width: 100%; padding: 0.5rem; border: 1px solid #ccc; border-radius: 4px; font-size: 0.95rem;"
                       oninput="filterVariables(this.value)">
            </div>

            <div id="variable-categories" style="flex: 1; overflow-y: auto; border: 1px solid #ddd; border-radius: 4px; min-height: 180px; max-height: 280px;">
                <!-- Categories will be rendered here -->
                <p style="padding: 1rem; color: #7f8c8d;">読み込み中... / Loading...</p>
            </div>

            <div style="padding-top: 0.5rem;">
                <small style="color: #7f8c8d;">
                    💡 変数をクリック → 作成エリアに追加 → 「挿入」ボタンで確定
                </small>
            </div>
        </div>

        <!-- Formula Help Tab Content -->
        {% raw %}
        <div id="vp-tab-formula" class="vp-tab-content" style="display: none;">
            <div class="formula-help" style="margin-top: 0.5rem;">
                <h4>📖 利用可能な関数 / Available Functions:</h4>
                <div class="formula-function-list">
                    <div class="formula-function">
                        <code>sum(a, b, ...)</code>
                        <span>合計 / Sum of values</span>
                    </div>
                </div>
                <h4 style="margin-top: 1rem;">💡 クリックで作成エリアに追加 / Click to add:</h4>
                <div class="formula-examples">
                    <code onclick="appendToComposition('sum()')">sum()</code>
                    <code onclick="appendToComposition('sum({{step1.score}}, {{step2.score}})')">sum({{step1.score}}, {{step2.score}})</code>
                    <code onclick="appendToComposition('sum({{input.value1}}, {{input.value2}})')">sum({{input.value1}}, {{input.value2}})</code>
                </div>
                <h4 style="margin-top: 1rem;">📝 数式の書き方 / How to write formulas:</h4>
                <p style="font-size: 0.85rem; color: #64748b; margin: 0.5rem 0;">
                    1. 変数タブから変数を選択<br>
                    2. 作成エリアで編集（カンマ追加など）<br>
                    3. sum()で囲むなど関数を適用<br>
                    4. 「挿入」ボタンで確定
                </p>
            </div>
        </div>
        {% endraw %}

        <!-- Action Buttons (shared) -->
        <div class="vp-actions">
            <button type="button" class="btn btn-primary" onclick="insertCompositionValue()">
                ➕ 挿入 / Insert
            </button>
            <button type="button" class="btn btn-secondary" onclick="clearComposition()">
                🗑️ クリア / Clear
            </button>
        </div>
    </div>
</div>

<!-- Draggable Prompt Editor Window -->
<div id="prompt-editor-window" class="draggable-window" style="display: none;">
    <div class="draggable-header" id="prompt-editor-header">
        <span class="draggable-title">📝 プロンプト編集 / Prompt Editor</span>
        <div class="draggable-controls">
            <button type="button" class="btn-header-help" onclick="showPromptTemplateHelp()" title="ヘルプを表示 / Show Help">❓</button>
            <button type="button" class="btn-minimize" onclick="minimizePromptEditor()" title="最小化">−</button>
            <button type="button" class="btn-close" onclick="closePromptEditor()" title="閉じる">×</button>
        </div>
    </div>
    <div class="draggable-body" id="prompt-editor-body">
        <input type="hidden" id="prompt-editor-prompt-id">
        <input type="hidden" id="prompt-editor-step-number">
        <input type="hidden" id="prompt-editor-current-revision">
        <input type="hidden" id="prompt-editor-project-id">

        <!-- Prompt Selector and New Prompt Button -->
        <div style="display: flex; gap: 0.5rem; align-items: center; margin-bottom: 0.8rem; padding-bottom: 0.8rem; border-bottom: 1px solid #e0e0e0;">
            <label style="font-size: 0.85rem; font-weight: bold; white-space: nowrap;">プロンプト:</label>
            <select id="prompt-editor-prompt-selector" onchange="onPromptEditorPromptChange(this.value)" style="flex: 1; padding: 0.4rem; border: 1px solid #ccc; border-radius: 4px;">
                <option value="">-- 読み込み中 --</option>
            </select>
            <button type="button" class="btn btn-success btn-sm" onclick="showCreatePromptInEditor()" style="white-space: nowrap; padding: 0.4rem 0.8rem;">
                ＋ 新規作成
            </button>
            <button type="button" class="btn btn-danger btn-sm" id="prompt-editor-delete-btn" onclick="deletePromptFromEditor()" style="white-space: nowrap; padding: 0.4rem 0.6rem;" title="削除 / Delete">
                🗑
            </button>
        </div>

        <!-- Prompt Metadata Editing Section -->
        <div class="prompt-editor-metadata" style="margin-bottom: 1rem; padding: 0.8rem; background: #f8f9fa; border-radius: 6px; border: 1px solid #e0e0e0;">
            <div style="display: flex; gap: 1rem; align-items: flex-start; flex-wrap: wrap;">
                <div style="flex: 1; min-width: 200px;">
                    <label for="prompt-editor-name" style="font-size: 0.85rem; font-weight: bold; display: block; margin-bottom: 0.3rem;">
                        プロンプト名 / Name:
                    </label>
                    <input type="text" id="prompt-editor-name"
                           style="width: 100%; padding: 0.4rem 0.6rem; border: 1px solid #ccc; border-radius: 4px; font-size: 0.9rem;"
                           placeholder="プロンプト名を入力">
                </div>
                <div style="flex: 2; min-width: 300px;">
                    <label for="prompt-editor-description" style="font-size: 0.85rem; font-weight: bold; display: block; margin-bottom: 0.3rem;">
                        説明 / Description:
                    </label>
                    <input type="text" id="prompt-editor-description"
                           style="width: 100%; padding: 0.4rem 0.6rem; border: 1px solid #ccc; border-radius: 4px; font-size: 0.9rem;"
                           placeholder="プロンプトの説明（任意）">
                </div>
                <div style="display: flex; align-items: flex-end; gap: 0.8rem;">
                    <span id="prompt-editor-id-info" style="color: #aaa; font-size: 0.75rem; padding-bottom: 0.5rem;"></span>
                    <span id="prompt-editor-revision-info" style="color: #7f8c8d; font-size: 0.85rem; padding-bottom: 0.5rem;"></span>
                </div>
            </div>
            <!-- Tag Selector Section -->
            <div style="margin-top: 0.8rem; padding-top: 0.8rem; border-top: 1px solid #e0e0e0;">
                <label style="font-size: 0.85rem; font-weight: bold; display: block; margin-bottom: 0.4rem;">
                    タグ / Tags:
                </label>
                <div id="prompt-editor-tags" class="prompt-editor-tags-container">
                    <div id="prompt-editor-current-tags" class="prompt-current-tags">
                        <!-- Dynamic tag chips will be inserted here -->
                    </div>
                    <button type="button" class="btn-add-prompt-tag" onclick="showPromptEditorTagDropdown(this)">+ タグ追加</button>
                </div>
            </div>
        </div>

        <!-- Prompt/Parser Tab Navigation -->
        <div class="prompt-editor-tabs">
            <button type="button" class="prompt-tab-btn active" data-tab="prompt" onclick="switchPromptEditorTab('prompt')">
                プロンプト
            </button>
            <button type="button" class="prompt-tab-btn" data-tab="parser" onclick="switchPromptEditorTab('parser')">
                パーサー
            </button>
        </div>

        <div class="prompt-editor-content">
            <!-- Prompt Tab -->
            <div id="prompt-editor-tab-prompt" class="prompt-editor-tab-content active">
                <div class="prompt-editor-main">
                    <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 0.5rem;">
                        <label style="margin: 0;">プロンプトテンプレート / Prompt Template:</label>
                        <div class="role-marker-buttons" style="display: flex; gap: 0.3rem; align-items: center;">
                            <span style="font-size: 0.75rem; color: #7f8c8d; margin-right: 0.3rem;">ロールマーカー:</span>
                            <button type="button" class="btn-marker btn-marker-system" onclick="insertRoleMarker('SYSTEM')" title="[SYSTEM] システム指示を挿入">
                                [SYSTEM]
                            </button>
                            <button type="button" class="btn-marker btn-marker-user" onclick="insertRoleMarker('USER')" title="[USER] ユーザー入力を挿入">
                                [USER]
                            </button>
                            <button type="button" class="btn-marker btn-marker-assistant" onclick="insertRoleMarker('ASSISTANT')" title="[ASSISTANT] アシスタント応答を挿入">
                                [ASSISTANT]
                            </button>
                            <button type="button" class="btn-marker-help" onclick="showRoleMarkerHelp()" title="ロールマーカーのヘルプ">
                                ❓
                            </button>
                        </div>
                    </div>
                    <textarea id="prompt-editor-template"></textarea>
                </div>
            </div>

            <!-- Parser Tab -->
            <div id="prompt-editor-tab-parser" class="prompt-editor-tab-content" style="display: none;">
                <div class="prompt-editor-main">
                    <label>パーサータイプ / Parser Type:</label>
                    <select id="prompt-editor-parser-type" onchange="onPromptEditorParserTypeChange()">
                        <option value="none">なし / None</option>
                        <option value="json">JSON (フィールド抽出)</option>
                        <option value="json_path">JSON Path</option>
                        <option value="regex">正規表現 / Regex</option>
                        <option value="csv_template">CSV Template</option>
                    </select>

                    <label style="margin-top: 1rem; display: block;">パーサー設定 (JSON):</label>
                    <textarea id="prompt-editor-parser-config" style="width: 100%; height: 200px; font-family: monospace; font-size: 0.85rem;" placeholder='{"type": "none"}'></textarea>
                    <div style="display: flex; justify-content: space-between; align-items: center; margin-top: 0.3rem;">
                        <small style="color: #7f8c8d;">例: {"type": "json_path", "paths": {"field1": "$.data.value"}}</small>
                        <button type="button" id="json-csv-toggle-btn-workflow" onclick="toggleJsonCsvConverter('-workflow')" style="font-size: 0.75rem; padding: 2px 8px; background: transparent; border: 1px solid #9b59b6; color: #9b59b6; border-radius: 3px; cursor: pointer;">JSON→CSV</button>
                    </div>
                    <!-- Inline JSON to CSV Converter (Workflow Editor) -->
                    <div id="json-csv-converter-section-workflow" style="margin-top: 10px; border: 1px solid #9b59b6; border-radius: 5px; display: none;">
                        <div style="background: #9b59b6; color: white; padding: 8px 12px; display: flex; justify-content: space-between; align-items: center;">
                            <span style="font-weight: bold;">📊 JSON → CSV 変換</span>
                            <button onclick="toggleJsonCsvConverter('-workflow')" style="background: transparent; border: 1px solid white; color: white; padding: 2px 8px; border-radius: 3px; cursor: pointer; font-size: 0.8rem;">閉じる</button>
                        </div>
                        <div style="padding: 10px;">
                            <div style="display: flex; gap: 10px;">
                                <div style="flex: 1;">
                                    <label style="font-size: 0.85rem; font-weight: bold; display: block; margin-bottom: 3px;">サンプルJSON入力:</label>
                                    <textarea id="json-sample-input-workflow" rows="6" style="font-family: 'Courier New', monospace; width: 100%; font-size: 0.85rem;" placeholder='{"field1": "value", "field2": {"nested": "data"}}'></textarea>
                                </div>
                                <div style="display: flex; flex-direction: column; justify-content: center; gap: 5px;">
                                    <button onclick="convertJsonToCsvTemplateInline('-workflow')" style="background: #9b59b6; color: white; border: none; padding: 8px 12px; border-radius: 3px; cursor: pointer; font-size: 0.85rem;">🔄 変換</button>
                                    <button onclick="applyGeneratedParserConfigInline('-workflow')" style="background: #27ae60; color: white; border: none; padding: 8px 12px; border-radius: 3px; cursor: pointer; font-size: 0.85rem;">✅ 適用</button>
                                </div>
                                <div style="flex: 1;">
                                    <label style="font-size: 0.85rem; font-weight: bold; display: block; margin-bottom: 3px;">生成された設定:</label>
                                    <textarea id="generated-parser-config-inline-workflow" rows="6" style="font-family: 'Courier New', monospace; width: 100%; font-size: 0.85rem; background: #f8f9fa;" readonly placeholder="変換結果がここに表示されます"></textarea>
                                </div>
                            </div>
                            <div style="margin-top: 5px;">
                                <label style="font-size: 0.85rem; font-weight: bold;">CSVヘッダープレビュー:</label>
                                <input type="text" id="csv-header-preview-inline-workflow" readonly style="width: 100%; font-family: 'Courier New', monospace; font-size: 0.85rem; background: #f8f9fa; padding: 4px;" placeholder="ヘッダーがここに表示されます">
                            </div>
                        </div>
                    </div>
                </div>
            </div>

            <div class="prompt-editor-sidebar">
                <div class="revision-header">
                    <span>📜 リビジョン</span>
                    <button type="button" class="btn btn-sm" onclick="loadPromptRevisions()" title="更新" style="padding: 2px 6px; font-size: 0.7rem;">🔄</button>
                </div>
                <ul class="revision-list" id="prompt-editor-revisions">
                    <li style="padding: 0.5rem; color: #9e9e9e; font-size: 0.8rem;">読み込み中...</li>
                </ul>
            </div>
        </div>
        <div class="prompt-editor-actions">
            <button type="button" class="btn btn-primary" onclick="savePromptFromEditor()">💾 保存 / Save</button>
            <button type="button" class="btn btn-secondary" onclick="closePromptEditor()">閉じる / Close</button>
            <span id="prompt-editor-status" style="margin-left: 1rem; color: #7f8c8d;"></span>
        </div>
    </div>
</div>

{% endblock %}

{% block scripts %}
<script src="/static/js/app.js?v=20251215_050000"></script>
{% endblock %}
